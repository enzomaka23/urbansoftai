<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UrbanSoft AI | Professional Assistant</title>
    <style>
        :root {
            --primary-dark: #0a0f1c;
            --primary-medium: #111827;
            --primary-light: #1f2937;
            --accent-blue: #3b82f6;
            --accent-cyan: #06b6d4;
            --accent-light: #f3f4f6;
            --border-blue: #1e40af;
            --text-light: #f9fafb;
            --text-gray: #9ca3af;
            --error: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            transition: all 0.3s ease;
        }
        
        /* Dark Theme (Default) */
        body.dark-theme {
            --primary-dark: #0a0f1c;
            --primary-medium: #111827;
            --primary-light: #1f2937;
            --accent-blue: #3b82f6;
            --accent-cyan: #06b6d4;
            --border-blue: #1e40af;
            --text-light: #f9fafb;
            --text-gray: #9ca3af;
        }
        
        /* Light Theme */
        body.light-theme {
            --primary-dark: #f3f4f6;
            --primary-medium: #ffffff;
            --primary-light: #f9fafb;
            --accent-blue: #2563eb;
            --accent-cyan: #0891b2;
            --border-blue: #93c5fd;
            --text-light: #1f2937;
            --text-gray: #6b7280;
        }
        
        /* Blue Theme */
        body.blue-theme {
            --primary-dark: #0c1a32;
            --primary-medium: #1a365d;
            --primary-light: #2d4a7c;
            --accent-blue: #4299e1;
            --accent-cyan: #63b3ed;
            --border-blue: #3182ce;
            --text-light: #e2e8f0;
            --text-gray: #a0aec0;
        }
        
        /* Purple Theme */
        body.purple-theme {
            --primary-dark: #1a103d;
            --primary-medium: #2d1b69;
            --primary-light: #3d2b8a;
            --accent-blue: #9f7aea;
            --accent-cyan: #b794f4;
            --border-blue: #805ad5;
            --text-light: #faf5ff;
            --text-gray: #c4b5fd;
        }
        
        /* Green Theme */
        body.green-theme {
            --primary-dark: #052e16;
            --primary-medium: #14532d;
            --primary-light: #166534;
            --accent-blue: #10b981;
            --accent-cyan: #34d399;
            --border-blue: #059669;
            --text-light: #f0fdf4;
            --text-gray: #86efac;
        }
        
        /* Red Theme */
        body.red-theme {
            --primary-dark: #450a0a;
            --primary-medium: #7f1d1d;
            --primary-light: #991b1b;
            --accent-blue: #ef4444;
            --accent-cyan: #f87171;
            --border-blue: #dc2626;
            --text-light: #fef2f2;
            --text-gray: #fca5a5;
        }
        
        /* Orange Theme */
        body.orange-theme {
            --primary-dark: #7c2d12;
            --primary-medium: #9a3412;
            --primary-light: #c2410c;
            --accent-blue: #f97316;
            --accent-cyan: #fb923c;
            --border-blue: #ea580c;
            --text-light: #fff7ed;
            --text-gray: #fdba74;
        }
        
        /* Pink Theme */
        body.pink-theme {
            --primary-dark: #831843;
            --primary-medium: #9d174d;
            --primary-light: #be185d;
            --accent-blue: #ec4899;
            --accent-cyan: #f472b6;
            --border-blue: #db2777;
            --text-light: #fdf2f8;
            --text-gray: #f9a8d4;
        }
        
        /* Midnight Theme */
        body.midnight-theme {
            --primary-dark: #0f172a;
            --primary-medium: #1e293b;
            --primary-light: #334155;
            --accent-blue: #60a5fa;
            --accent-cyan: #38bdf8;
            --border-blue: #3b82f6;
            --text-light: #f8fafc;
            --text-gray: #94a3b8;
        }
        
        /* Gold Theme */
        body.gold-theme {
            --primary-dark: #451a03;
            --primary-medium: #7c2d12;
            --primary-light: #9a3412;
            --accent-blue: #fbbf24;
            --accent-cyan: #fcd34d;
            --border-blue: #f59e0b;
            --text-light: #fffbeb;
            --text-gray: #fde68a;
        }
        
        /* Cyberpunk Theme */
        body.cyberpunk-theme {
            --primary-dark: #0f0f23;
            --primary-medium: #1a1a2e;
            --primary-light: #16213e;
            --accent-blue: #00ff9d;
            --accent-cyan: #00eeff;
            --border-blue: #00b8ff;
            --text-light: #e6e6ff;
            --text-gray: #a3a3cc;
        }
        
        /* Ocean Theme */
        body.ocean-theme {
            --primary-dark: #0c4a6e;
            --primary-medium: #075985;
            --primary-light: #0369a1;
            --accent-blue: #0ea5e9;
            --accent-cyan: #22d3ee;
            --border-blue: #0284c7;
            --text-light: #f0f9ff;
            --text-gray: #7dd3fc;
        }
        
        /* Forest Theme */
        body.forest-theme {
            --primary-dark: #14532d;
            --primary-medium: #166534;
            --primary-light: #15803d;
            --accent-blue: #22c55e;
            --accent-cyan: #4ade80;
            --border-blue: #16a34a;
            --text-light: #f0fdf4;
            --text-gray: #86efac;
        }
        
        /* Sunset Theme */
        body.sunset-theme {
            --primary-dark: #7c2d12;
            --primary-medium: #ea580c;
            --primary-light: #fb923c;
            --accent-blue: #f97316;
            --accent-cyan: #fdba74;
            --border-blue: #f97316;
            --text-light: #fff7ed;
            --text-gray: #fed7aa;
        }
        
        /* Galaxy Theme */
        body.galaxy-theme {
            --primary-dark: #1e1b4b;
            --primary-medium: #312e81;
            --primary-light: #4338ca;
            --accent-blue: #818cf8;
            --accent-cyan: #a5b4fc;
            --border-blue: #6366f1;
            --text-light: #eef2ff;
            --text-gray: #c7d2fe;
        }
        
        /* Neon Theme */
        body.neon-theme {
            --primary-dark: #1a0033;
            --primary-medium: #330066;
            --primary-light: #4d0099;
            --accent-blue: #ff00ff;
            --accent-cyan: #00ffff;
            --border-blue: #cc00ff;
            --text-light: #f0f0ff;
            --text-gray: #cc99ff;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: var(--primary-dark);
            color: var(--text-light);
            min-height: 100vh;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .auth-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .auth-container {
            background: var(--primary-medium);
            border-radius: 28px;
            padding: 40px;
            width: 100%;
            max-width: 450px;
            border: 1px solid var(--border-blue);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .logo-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .logo-header h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .logo-header p {
            color: var(--text-gray);
            font-size: 1.1rem;
        }
        
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: var(--primary-light);
            padding: 8px;
            border-radius: 20px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            color: var(--text-gray);
            font-size: 1.1rem;
            cursor: pointer;
            border-radius: 15px;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            background: var(--accent-blue);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: var(--accent-light);
            font-size: 0.95rem;
        }
        
        .form-group input {
            width: 100%;
            padding: 18px;
            background: var(--primary-light);
            border: 2px solid var(--border-blue);
            border-radius: 15px;
            color: var(--text-light);
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        .btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px var(--accent-blue);
        }
        
        .btn-secondary {
            background: var(--primary-light);
            border: 2px solid var(--border-blue);
        }
        
        .btn-small {
            padding: 10px 20px;
            font-size: 0.9rem;
        }
        
        .btn-danger {
            background: linear-gradient(90deg, var(--error), #dc2626);
        }
        
        .btn-warning {
            background: linear-gradient(90deg, var(--warning), #d97706);
        }
        
        .message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }
        
        .message.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid var(--error);
        }
        
        .message.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--text-gray);
            border-radius: 50%;
            border-top-color: var(--accent-blue);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .chat-app {
            display: none;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }
        
        .chat-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
        }
        
        .left-sidebar {
            width: 320px;
            background: var(--primary-medium);
            border-right: 1px solid var(--border-blue);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            height: 100vh;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 25px;
            border-bottom: 1px solid var(--border-blue);
            background: var(--primary-dark);
        }
        
        .sidebar-header h2 {
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .user-role {
            padding: 6px 12px;
            background: var(--accent-blue);
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .user-role.admin {
            background: linear-gradient(90deg, #8b5cf6, #ec4899);
        }
        
        .user-role.user {
            background: linear-gradient(90deg, #3b82f6, #06b6d4);
        }
        
        .projects-section {
            padding: 20px;
            border-bottom: 1px solid var(--border-blue);
            background: var(--primary-medium);
        }
        
        .projects-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .projects-header h3 {
            font-size: 1.1rem;
            color: var(--text-light);
        }
        
        .project-actions {
            display: flex;
            gap: 5px;
        }
        
        .project-action-btn {
            width: 32px;
            height: 32px;
            background: var(--accent-blue);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .project-action-btn:hover {
            transform: rotate(90deg);
        }
        
        .projects-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .project-item {
            padding: 12px;
            background: var(--primary-light);
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .project-item:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--border-blue);
        }
        
        .project-item.drag-over {
            background: rgba(6, 182, 212, 0.2);
            border-color: var(--accent-cyan);
            transform: scale(1.02);
        }
        
        .project-actions-small {
            display: none;
            gap: 5px;
        }
        
        .project-item:hover .project-actions-small {
            display: flex;
        }
        
        .project-action-small {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 1px solid var(--border-blue);
            background: var(--primary-light);
            color: var(--text-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            transition: all 0.3s;
        }
        
        .project-action-small:hover {
            background: var(--accent-blue);
        }
        
        .chats-section {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            background: var(--primary-dark);
        }
        
        .chats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .chats-header h3 {
            font-size: 1.1rem;
            color: var(--text-light);
        }
        
        .search-box {
            flex: 1;
            padding: 10px 15px;
            background: var(--primary-light);
            border: 1px solid var(--border-blue);
            border-radius: 20px;
            color: var(--text-light);
            font-size: 0.9rem;
            margin-right: 10px;
        }
        
        .new-chat-btn {
            width: 36px;
            height: 36px;
            background: var(--accent-blue);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.4rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .new-chat-btn:hover {
            transform: rotate(90deg);
        }
        
        .chats-list {
            flex: 1;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .chat-item {
            padding: 12px;
            background: var(--primary-light);
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
            position: relative;
        }
        
        .chat-item:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--border-blue);
        }
        
        .chat-item.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: var(--accent-blue);
        }
        
        .chat-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        
        .chat-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .chat-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-light);
        }
        
        .chat-time {
            font-size: 0.75rem;
            color: var(--text-gray);
        }
        
        .chat-preview {
            font-size: 0.85rem;
            color: var(--text-gray);
            margin-top: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-actions {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: none;
            gap: 5px;
        }
        
        .chat-item:hover .chat-actions {
            display: flex;
        }
        
        .chat-action-btn {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 1px solid var(--border-blue);
            background: var(--primary-light);
            color: var(--text-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            transition: all 0.3s;
        }
        
        .chat-action-btn:hover {
            background: var(--accent-blue);
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--primary-dark);
            margin: 0;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }
        
        .chat-header-area {
            padding: 15px 30px;
            border-bottom: 1px solid var(--border-blue);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--primary-medium);
            min-height: 70px;
        }
        
        .chat-title-area {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .chat-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-light);
        }
        
        .chat-actions-area {
            display: flex;
            gap: 10px;
            position: relative;
        }
        
        .chat-menu-btn {
            width: 40px;
            height: 40px;
            background: var(--primary-light);
            border: 1px solid var(--border-blue);
            border-radius: 12px;
            color: var(--text-light);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-menu-btn:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .dropdown-menu {
            position: absolute;
            top: 50px;
            right: 0;
            background: var(--primary-light);
            border: 1px solid var(--border-blue);
            border-radius: 12px;
            padding: 10px;
            min-width: 200px;
            display: none;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .dropdown-menu.show {
            display: block;
        }
        
        .dropdown-menu button {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 12px;
            background: transparent;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s;
            font-size: 0.95rem;
        }
        
        .dropdown-menu button:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .messages-container {
            flex: 1;
            overflow: hidden;
            position: relative;
            width: 100%;
            height: calc(100vh - 180px);
        }
        
        .messages {
            height: 100%;
            overflow-y: auto;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 0;
        }
        
        .welcome-message {
            text-align: center;
            padding: 60px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 25px;
            border: 1px solid var(--border-blue);
            max-width: 800px;
            margin: 60px auto;
        }
        
        .welcome-message h3 {
            font-size: 2.5rem;
            margin-bottom: 30px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .welcome-message p {
            color: var(--text-gray);
            font-size: 1.2rem;
            margin-bottom: 15px;
        }
        
        .message-bubble {
            max-width: 90%;
            padding: 18px 22px;
            border-radius: 22px;
            position: relative;
        }
        
        .message-bubble.user {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            border-bottom-right-radius: 6px;
        }
        
        .message-bubble.ai {
            align-self: flex-start;
            background: var(--primary-light);
            border: 1px solid var(--border-blue);
            border-bottom-left-radius: 6px;
        }
        
        .message-content {
            line-height: 1.6;
            font-size: 1.05rem;
            color: var(--text-light);
        }
        
        .message-bubble.user .message-content {
            color: white;
        }
        
        .message-time {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 8px;
            text-align: right;
        }
        
        .message-bubble.ai .message-time {
            color: var(--text-gray);
        }
        
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 15px 20px;
            background: var(--primary-light);
            border: 1px solid var(--border-blue);
            border-radius: 22px;
            align-self: flex-start;
            border-bottom-left-radius: 6px;
        }
        
        .typing-dot {
            width: 9px;
            height: 9px;
            background: var(--text-gray);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-6px);
            }
        }
        
        .input-container {
            padding: 20px 30px;
            border-top: 1px solid var(--border-blue);
            background: var(--primary-medium);
            min-height: 110px;
        }
        
        .input-wrapper {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }
        
        .input-wrapper textarea {
            flex: 1;
            min-height: 50px;
            max-height: 150px;
            background: var(--primary-light);
            border: 2px solid var(--border-blue);
            border-radius: 25px;
            color: var(--text-light);
            font-size: 1rem;
            resize: none;
            padding: 15px 25px;
            outline: none;
            font-family: inherit;
        }
        
        .input-wrapper textarea:focus {
            border-color: var(--accent-blue);
        }
        
        .attach-btn {
            width: 45px;
            height: 45px;
            background: var(--primary-light);
            border: 1px solid var(--border-blue);
            border-radius: 50%;
            color: var(--text-light);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .attach-btn:hover {
            background: var(--accent-blue);
            color: white;
        }
        
        .send-btn {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .send-btn:hover {
            transform: scale(1.1);
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: var(--text-gray);
            margin-top: 15px;
        }
        
        .api-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .status-indicator.connected {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
        }
        
        .status-indicator.disconnected {
            background: var(--error);
            box-shadow: 0 0 10px var(--error);
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--primary-medium);
            border-radius: 28px;
            padding: 40px;
            width: 100%;
            max-width: 500px;
            border: 1px solid var(--border-blue);
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            margin-bottom: 30px;
            position: relative;
            flex-shrink: 0;
        }
        
        .modal-header h3 {
            color: var(--text-light);
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        
        .modal-header p {
            color: var(--text-gray);
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .close-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: transparent;
            border: none;
            color: var(--text-gray);
            font-size: 2rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .close-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }
        
        .modal-body {
            margin-bottom: 30px;
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .modal-footer {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            flex-shrink: 0;
            padding-top: 20px;
            border-top: 1px solid var(--border-blue);
            margin-top: 20px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            background: var(--primary-light);
            border: 2px solid var(--border-blue);
            border-radius: 12px;
            color: var(--text-light);
            font-size: 1rem;
            margin-bottom: 15px;
        }
        
        /* Change PIN Modal */
        .change-pin-modal {
            max-width: 500px;
        }
        
        .pin-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
        }
        
        .pin-input {
            width: 60px;
            height: 70px;
            font-size: 2rem;
            text-align: center;
            background: var(--primary-light);
            border: 2px solid var(--border-blue);
            border-radius: 15px;
            color: var(--text-light);
            transition: all 0.3s;
        }
        
        .pin-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        .pin-input.filled {
            border-color: var(--accent-cyan);
            background: rgba(6, 182, 212, 0.1);
        }
        
        .pin-input.error {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.1);
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% {
                transform: translateX(0);
            }
            25% {
                transform: translateX(-10px);
            }
            75% {
                transform: translateX(10px);
            }
        }
        
        .pin-hint {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            font-size: 0.9rem;
            color: var(--text-gray);
        }
        
        .pin-hint.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }
        
        .pin-hint.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .pin-instructions {
            padding: 15px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid var(--border-blue);
        }
        
        .pin-instructions p {
            color: var(--text-gray);
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .settings-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-blue);
            overflow-x: auto;
            flex-shrink: 0;
        }
        
        .settings-tab {
            padding: 12px 24px;
            background: transparent;
            border: 1px solid var(--border-blue);
            border-radius: 12px;
            color: var(--text-gray);
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .settings-tab.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }
        
        .settings-content {
            min-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .settings-section {
            display: none;
        }
        
        .settings-section.active {
            display: block;
        }
        
        .settings-group {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: var(--primary-light);
            border-radius: 15px;
            border: 1px solid var(--border-blue);
        }
        
        .setting-label {
            font-weight: 500;
            color: var(--text-light);
        }
        
        .setting-control {
            padding: 10px 15px;
            background: var(--primary-medium);
            border: 1px solid var(--border-blue);
            border-radius: 10px;
            color: var(--text-light);
            min-width: 150px;
        }
        
        .theme-selector {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        .theme-option {
            flex: 1;
            min-width: 120px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .theme-card {
            background: var(--primary-light);
            border: 2px solid var(--border-blue);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .theme-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .theme-card.active {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        .theme-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .theme-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 5px;
            color: var(--text-light);
        }
        
        .theme-desc {
            font-size: 0.8rem;
            color: var(--text-gray);
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--primary-medium);
            border: 1px solid var(--border-blue);
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 3px;
            background-color: var(--text-gray);
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--accent-blue);
            border-color: var(--accent-blue);
        }
        
        input:checked + .slider:before {
            transform: translateX(28px);
            background-color: white;
        }
        
        .tfa-status {
            margin-top: 20px;
            padding: 20px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 15px;
            border: 1px solid var(--border-blue);
        }
        
        .pin-management {
            margin-top: 20px;
            padding: 20px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 15px;
            border: 1px solid var(--success);
        }
        
        .pin-management h4 {
            color: var(--success);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .about-content {
            padding: 20px;
            background: var(--primary-light);
            border-radius: 15px;
            border: 1px solid var(--border-blue);
        }
        
        .about-content p {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-blue);
            color: var(--text-light);
        }
        
        .about-content p:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        /* Profile settings styles */
        .profile-section {
            padding: 20px 0;
        }
        
        .profile-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-blue);
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            font-weight: bold;
        }
        
        .profile-info h4 {
            font-size: 1.3rem;
            margin-bottom: 5px;
            color: var(--text-light);
        }
        
        .profile-info p {
            color: var(--text-gray);
            font-size: 0.9rem;
        }
        
        .profile-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .password-requirements {
            font-size: 0.85rem;
            color: var(--text-gray);
            margin-top: 5px;
        }
        
        /* User Management Styles */
        .user-management-controls {
            margin-bottom: 25px;
        }
        
        .search-filter-area {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .search-filter-area .search-box {
            flex: 2;
            margin: 0;
        }
        
        .search-filter-area .setting-control {
            flex: 1;
            min-width: 150px;
        }
        
        .user-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .stat-card {
            flex: 1;
            min-width: 120px;
            background: var(--primary-light);
            border: 1px solid var(--border-blue);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent-blue);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--text-gray);
        }
        
        .users-list-container {
            background: var(--primary-medium);
            border: 1px solid var(--border-blue);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .users-list-header {
            display: flex;
            background: var(--primary-dark);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-blue);
            font-weight: 600;
            color: var(--text-light);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .user-column {
            padding: 0 10px;
        }
        
        .users-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-blue);
            transition: background 0.3s;
        }
        
        .user-item:hover {
            background: rgba(59, 130, 246, 0.05);
        }
        
        .user-item:last-child {
            border-bottom: none;
        }
        
        .user-info-cell {
            flex: 2;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar-small {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }
        
        .user-details {
            flex: 1;
        }
        
        .user-name {
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 3px;
        }
        
        .user-email {
            font-size: 0.85rem;
            color: var(--text-gray);
        }
        
        .user-username {
            font-size: 0.8rem;
            color: var(--accent-cyan);
            background: rgba(6, 182, 212, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-top: 3px;
        }
        
        .user-role-cell {
            flex: 1;
        }
        
        .role-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .role-badge.admin {
            background: linear-gradient(90deg, #8b5cf6, #ec4899);
            color: white;
        }
        
        .role-badge.user {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-blue);
        }
        
        .user-status-cell {
            flex: 1;
        }
        
        .status-indicator-user {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .status-dot.active {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
        }
        
        .status-dot.inactive {
            background: var(--text-gray);
        }
        
        .user-time-cell {
            flex: 1.5;
            color: var(--text-gray);
            font-size: 0.9rem;
        }
        
        .user-actions-cell {
            flex: 1.5;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .user-action-btn {
            padding: 6px 12px;
            border: 1px solid var(--border-blue);
            background: var(--primary-light);
            color: var(--text-light);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .user-action-btn:hover {
            transform: translateY(-2px);
        }
        
        .user-action-btn.edit {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--accent-blue);
        }
        
        .user-action-btn.delete {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--error);
        }
        
        .user-action-btn.delete:hover {
            background: var(--error);
            color: white;
        }
        
        .user-action-btn.reset {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--warning);
        }
        
        .user-action-btn.impersonate {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--success);
        }
        
        .user-action-btn.impersonate:hover {
            background: var(--success);
            color: white;
        }
        
        /* Project Files Management Styles */
        .project-files-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-blue);
        }
        
        .project-info h4 {
            font-size: 1.5rem;
            color: var(--text-light);
            margin-bottom: 5px;
        }
        
        .project-info p {
            color: var(--text-gray);
            font-size: 0.9rem;
        }
        
        .file-actions {
            display: flex;
            gap: 10px;
        }
        
        .file-management-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-blue);
            padding-bottom: 10px;
        }
        
        .file-tab {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--border-blue);
            border-radius: 10px;
            color: var(--text-gray);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-tab.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }
        
        .file-tab-content {
            display: none;
            min-height: 300px;
        }
        
        .file-tab-content.active {
            display: block;
        }
        
        .files-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .file-item {
            background: var(--primary-light);
            border: 1px solid var(--border-blue);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .file-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            border-color: var(--accent-blue);
        }
        
        .file-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .file-name {
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-info {
            font-size: 0.8rem;
            color: var(--text-gray);
            margin-bottom: 5px;
        }
        
        .file-actions-small {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .file-item:hover .file-actions-small {
            opacity: 1;
        }
        
        .file-action-btn {
            flex: 1;
            padding: 5px;
            background: var(--primary-dark);
            border: 1px solid var(--border-blue);
            border-radius: 6px;
            color: var(--text-light);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }
        
        .file-action-btn:hover {
            background: var(--accent-blue);
            color: white;
        }
        
        .chats-in-project {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .project-chat-item {
            background: var(--primary-light);
            border: 1px solid var(--border-blue);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .project-chat-item:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--accent-blue);
        }
        
        .project-chat-name {
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 5px;
        }
        
        .project-chat-preview {
            font-size: 0.9rem;
            color: var(--text-gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .project-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .project-stats .stat-card {
            flex: 1;
            min-width: 100px;
        }
        
        .project-details {
            background: var(--primary-light);
            border: 1px solid var(--border-blue);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-blue);
        }
        
        .detail-item:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 600;
            color: var(--text-light);
        }
        
        .detail-value {
            color: var(--text-gray);
            text-align: right;
        }
        
        .quick-actions {
            margin-top: 20px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* Upload Methods */
        .upload-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .upload-method {
            background: var(--primary-light);
            border: 2px solid var(--border-blue);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-method:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            border-color: var(--accent-blue);
        }
        
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .upload-title {
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        .upload-desc {
            color: var(--text-gray);
            font-size: 0.9rem;
        }
        
        /* Chats Selector */
        .chats-selector {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .search-chats {
            margin-bottom: 20px;
        }
        
        .available-chats {
            border: 1px solid var(--border-blue);
            border-radius: 10px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .chat-select-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: var(--primary-light);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .chat-select-item:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .chat-select-item.selected {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid var(--accent-blue);
        }
        
        .chat-select-checkbox {
            margin-right: 10px;
        }
        
        .chat-select-info {
            flex: 1;
        }
        
        .selected-chats {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            border-radius: 10px;
            padding: 15px;
        }
        
        .selected-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .selected-tag {
            background: var(--success);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .remove-tag {
            cursor: pointer;
            font-size: 1rem;
        }
        
        /* Drop Zone */
        .drop-zone {
            border: 2px dashed var(--accent-blue);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            margin-top: 5px;
            background: rgba(59, 130, 246, 0.05);
            color: var(--text-gray);
            font-size: 0.8rem;
        }
        
        .drop-zone.active {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--accent-cyan);
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--primary-light);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--accent-blue);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-cyan);
        }
        
        @media (max-width: 768px) {
            .auth-container {
                padding: 30px 20px;
            }
            
            .chat-header-area {
                padding: 20px;
            }
            
            .input-container {
                padding: 20px;
            }
            
            .message-bubble {
                max-width: 95%;
            }
            
            .left-sidebar {
                width: 280px;
            }
            
            .messages {
                padding: 20px;
            }
            
            .welcome-message {
                padding: 40px;
                margin: 40px auto;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .theme-selector {
                flex-direction: column;
            }
            
            .theme-option {
                min-width: 100%;
            }
            
            .modal-content {
                max-height: 90vh;
                padding: 30px 20px;
            }
            
            .pin-input {
                width: 50px;
                height: 60px;
                font-size: 1.5rem;
            }
            
            .user-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .user-actions-cell {
                width: 100%;
                justify-content: center;
            }
            
            .files-list {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="auth-screen" id="authScreen">
        <div class="auth-container">
            <div class="logo-header">
                <h1>UrbanSoft AI</h1>
                <p>Professional Assistant</p>
            </div>
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('signin')">Sign In</button>
                <button class="tab-btn" onclick="switchTab('signup')">Sign Up</button>
            </div>
            <div id="signin" class="tab-content active">
                <form id="signinForm" onsubmit="handleSignIn(event)">
                    <div class="form-group">
                        <label for="signinUsername">Username</label>
                        <input type="text" id="signinUsername" placeholder="Enter your username" required>
                    </div>
                    <div class="form-group">
                        <label for="signinPassword">Password</label>
                        <input type="password" id="signinPassword" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn">Sign In</button>
                </form>
                <div id="signinMessage" class="message"></div>
            </div>
            <div id="signup" class="tab-content">
                <form id="signupForm" onsubmit="handleSignUp(event)">
                    <div class="form-group">
                        <label for="firstName">First Name</label>
                        <input type="text" id="firstName" placeholder="Enter your first name" required>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Last Name</label>
                        <input type="text" id="lastName" placeholder="Enter your last name" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" placeholder="Choose a username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" placeholder="Minimum 8 characters" required>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
                    </div>
                    <button type="submit" class="btn">Create Account</button>
                </form>
                <div id="signupMessage" class="message"></div>
            </div>
        </div>
    </div>

    <!-- Change PIN Modal -->
    <div class="modal change-pin-modal" id="changePinModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3> Change PIN</h3>
                <p>Update your 4-digit security PIN</p>
                <button class="close-btn" onclick="closeChangePinModal()"></button>
            </div>
            <div class="modal-body">
                <div class="pin-instructions">
                    <p> For security, you must verify your current PIN first</p>
                </div>
                
                <h4 style="color: var(--text-light); margin-bottom: 15px;">1. Verify Current PIN</h4>
                <div class="pin-container" id="verifyCurrentPinContainer">
                    <input type="password" class="pin-input" maxlength="1" data-index="0" oninput="handleChangePinInput('current', event)">
                    <input type="password" class="pin-input" maxlength="1" data-index="1" oninput="handleChangePinInput('current', event)">
                    <input type="password" class="pin-input" maxlength="1" data-index="2" oninput="handleChangePinInput('current', event)">
                    <input type="password" class="pin-input" maxlength="1" data-index="3" oninput="handleChangePinInput('current', event)">
                </div>
                <div class="pin-hint" id="verifyCurrentPinHint">Enter your current 4-digit PIN</div>
                
                <h4 style="color: var(--text-light); margin-top: 30px; margin-bottom: 15px;">2. Enter New PIN</h4>
                <div class="pin-container" id="newPinContainer">
                    <input type="password" class="pin-input" maxlength="1" data-index="0" oninput="handleChangePinInput('new', event)" disabled>
                    <input type="password" class="pin-input" maxlength="1" data-index="1" oninput="handleChangePinInput('new', event)" disabled>
                    <input type="password" class="pin-input" maxlength="1" data-index="2" oninput="handleChangePinInput('new', event)" disabled>
                    <input type="password" class="pin-input" maxlength="1" data-index="3" oninput="handleChangePinInput('new', event)" disabled>
                </div>
                <div class="pin-hint" id="newPinHint">New PIN will be enabled after verification</div>
                
                <h4 style="color: var(--text-light); margin-top: 30px; margin-bottom: 15px;">3. Confirm New PIN</h4>
                <div class="pin-container" id="confirmPinContainer">
                    <input type="password" class="pin-input" maxlength="1" data-index="0" oninput="handleChangePinInput('confirm', event)" disabled>
                    <input type="password" class="pin-input" maxlength="1" data-index="1" oninput="handleChangePinInput('confirm', event)" disabled>
                    <input type="password" class="pin-input" maxlength="1" data-index="2" oninput="handleChangePinInput('confirm', event)" disabled>
                    <input type="password" class="pin-input" maxlength="1" data-index="3" oninput="handleChangePinInput('confirm', event)" disabled>
                </div>
                <div class="pin-hint" id="confirmPinHint">Confirm your new PIN</div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="saveNewPIN()" id="saveNewPinBtn" disabled>Change PIN</button>
                <button class="btn btn-secondary" onclick="closeChangePinModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- TFA Setup Modal -->
    <div class="modal tfa-modal" id="tfaSetupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3> Setup Two-Factor Authentication</h3>
                <p>Create a 4-digit PIN for extra security</p>
                <button class="close-btn" onclick="closeTfaSetupModal()"></button>
            </div>
            <div class="modal-body">
                <div class="pin-container" id="setupPinContainer">
                    <input type="password" class="pin-input" maxlength="1" data-index="0" oninput="handlePinInput('setup', event)">
                    <input type="password" class="pin-input" maxlength="1" data-index="1" oninput="handlePinInput('setup', event)">
                    <input type="password" class="pin-input" maxlength="1" data-index="2" oninput="handlePinInput('setup', event)">
                    <input type="password" class="pin-input" maxlength="1" data-index="3" oninput="handlePinInput('setup', event)">
                </div>
                <div class="pin-hint" id="setupPinHint">Enter a 4-digit PIN</div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="saveTFAPIN()" id="savePinBtn" disabled>Save PIN</button>
                <button class="btn btn-secondary" onclick="skip2FASetup()">Skip for now</button>
            </div>
        </div>
    </div>

    <!-- TFA Verify Modal -->
    <div class="modal tfa-modal" id="tfaVerifyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3> Two-Factor Authentication</h3>
                <p>Enter your 4-digit PIN to continue</p>
                <button class="close-btn" onclick="logoutFrom2FA()"></button>
            </div>
            <div class="modal-body">
                <div class="pin-container" id="verifyPinContainer">
                    <input type="password" class="pin-input" maxlength="1" data-index="0" oninput="handlePinInput('verify', event)">
                    <input type="password" class="pin-input" maxlength="1" data-index="1" oninput="handlePinInput('verify', event)">
                    <input type="password" class="pin-input" maxlength="1" data-index="2" oninput="handlePinInput('verify', event)">
                    <input type="password" class="pin-input" maxlength="1" data-index="3" oninput="handlePinInput('verify', event)">
                </div>
                <div class="pin-hint" id="verifyPinHint">Enter your 4-digit PIN</div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="verifyTFAPIN()" id="verifyPinBtn" disabled>Verify PIN</button>
                <button class="btn btn-secondary" onclick="logoutFrom2FA()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div class="modal" id="userManagementModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3> User Management</h3>
                <p>Manage all users in the UrbanSoft AI system</p>
                <button class="close-btn" onclick="closeUserManagement()"></button>
            </div>
            <div class="modal-body">
                <div class="user-management-controls">
                    <div class="search-filter-area">
                        <input type="text" id="searchUsers" class="search-box" placeholder="Search users..." oninput="filterUsers()">
                        <select id="roleFilter" class="setting-control" onchange="filterUsers()">
                            <option value="all">All Roles</option>
                            <option value="admin">Admin</option>
                            <option value="user">User</option>
                        </select>
                    </div>
                    
                    <div class="user-stats">
                        <div class="stat-card">
                            <div class="stat-number" id="totalUsers">0</div>
                            <div class="stat-label">Total Users</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="adminCount">0</div>
                            <div class="stat-label">Admins</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="userCount">0</div>
                            <div class="stat-label">Regular Users</div>
                        </div>
                    </div>
                </div>
                
                <div class="users-list-container">
                    <div class="users-list-header">
                        <div class="user-column" style="flex: 2;">User Info</div>
                        <div class="user-column" style="flex: 1;">Role</div>
                        <div class="user-column" style="flex: 1;">Status</div>
                        <div class="user-column" style="flex: 1.5;">Last Login</div>
                        <div class="user-column" style="flex: 1.5;">Actions</div>
                    </div>
                    <div class="users-list" id="usersList"></div>
                </div>
                
                <div id="noUsersMessage" style="text-align: center; padding: 40px; color: var(--text-gray); display: none;">
                    <div style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;"></div>
                    <p>No users found</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="exportUsersCSV()"> Export CSV</button>
                <button class="btn btn-secondary" onclick="refreshUserList()"> Refresh</button>
                <div style="flex: 1;"></div>
                <button class="btn" onclick="openAddUserModal()"> Add New User</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div class="modal" id="editUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="editUserModalTitle"> Add New User</h3>
                <p id="editUserModalDesc">Create a new user account</p>
                <button class="close-btn" onclick="closeEditUserModal()"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editFirstName">First Name</label>
                            <input type="text" id="editFirstName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="editLastName">Last Name</label>
                            <input type="text" id="editLastName" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editEmail">Email Address</label>
                        <input type="email" id="editEmail" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="editUsername">Username</label>
                        <input type="text" id="editUsername" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="editRole">Role</label>
                        <select id="editRole" class="form-control" required>
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editPassword">Password</label>
                        <input type="password" id="editPassword" class="form-control" placeholder="Leave blank to keep existing">
                    </div>
                    <div class="form-group" id="confirmPasswordGroup">
                        <label for="editConfirmPassword">Confirm Password</label>
                        <input type="password" id="editConfirmPassword" class="form-control" placeholder="Confirm new password">
                    </div>
                    <div class="form-group">
                        <label class="switch">
                            <input type="checkbox" id="editTFAEnabled">
                            <span class="slider"></span>
                            <span style="margin-left: 10px; color: var(--text-light);">Enable Two-Factor Authentication</span>
                        </label>
                    </div>
                    <div id="editUserMessage" class="message"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="saveUser()" id="saveUserBtn">Save User</button>
                <button class="btn btn-secondary" onclick="closeEditUserModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirmActionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="confirmActionTitle"> Confirm Action</h3>
                <p id="confirmActionMessage"></p>
                <button class="close-btn" onclick="closeConfirmModal()"></button>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="confirmActionBtn">Confirm</button>
                <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Project Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="projectModalTitle"> Create Project</h3>
                <p id="projectModalDesc">Organize your chats and files into projects</p>
                <button class="close-btn" onclick="closeProjectModal()"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="projectNameInput" class="form-control" placeholder="Project name" required>
                <textarea id="projectDescInput" class="form-control" placeholder="Description (optional)" rows="3"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="saveProject()" id="saveProjectBtn">Create Project</button>
                <button class="btn btn-secondary" onclick="closeProjectModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Project Files Modal -->
    <div class="modal" id="projectFilesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="projectFilesTitle"> Project Files</h3>
                <p id="projectFilesDesc"></p>
                <button class="close-btn" onclick="closeProjectFilesModal()"></button>
            </div>
            <div class="modal-body">
                <div class="project-files-header">
                    <div class="project-info">
                        <h4 id="projectFilesName">Project Name</h4>
                        <p id="projectFilesInfo">Created: Loading...</p>
                    </div>
                    <div class="file-actions">
                        <button class="project-action-btn" onclick="addFileToProject()" title="Add File"></button>
                        <button class="project-action-btn" onclick="importChatsToProject()" title="Add Chats"></button>
                    </div>
                </div>
                
                <div class="file-management-tabs">
                    <button class="file-tab active" onclick="switchFileTab('files')"> Files</button>
                    <button class="file-tab" onclick="switchFileTab('chats')"> Chats</button>
                    <button class="file-tab" onclick="switchFileTab('info')"> Info</button>
                </div>
                
                <!-- Files Tab -->
                <div id="filesTab" class="file-tab-content active">
                    <div class="files-list" id="projectFilesList">
                        <div class="no-files" id="noFilesMessage">
                            <div style="text-align: center; padding: 40px; color: var(--text-gray);">
                                <div style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;"></div>
                                <p>No files in this project</p>
                                <button class="btn btn-small" onclick="addFileToProject()" style="margin-top: 10px;">Add First File</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Chats Tab -->
                <div id="chatsTab" class="file-tab-content">
                    <div class="chats-in-project" id="projectChatsList">
                        <div class="no-chats" id="noChatsMessage">
                            <div style="text-align: center; padding: 40px; color: var(--text-gray);">
                                <div style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;"></div>
                                <p>No chats in this project</p>
                                <button class="btn btn-small" onclick="importChatsToProject()" style="margin-top: 10px;">Add Chats</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Info Tab -->
                <div id="infoTab" class="file-tab-content">
                    <div class="project-stats">
                        <div class="stat-card">
                            <div class="stat-number" id="fileCount">0</div>
                            <div class="stat-label">Files</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="chatCount">0</div>
                            <div class="stat-label">Chats</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalSize">0 KB</div>
                            <div class="stat-label">Total Size</div>
                        </div>
                    </div>
                    
                    <div class="project-details">
                        <h4 style="margin: 20px 0 10px 0; color: var(--text-light);">Project Details</h4>
                        <div class="detail-item">
                            <span class="detail-label">Created:</span>
                            <span class="detail-value" id="projectCreated">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Created by:</span>
                            <span class="detail-value" id="projectCreator">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Last Modified:</span>
                            <span class="detail-value" id="projectModified">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Description:</span>
                            <span class="detail-value" id="projectDescription">No description</span>
                        </div>
                    </div>
                    
                    <div class="quick-actions">
                        <h4 style="margin: 20px 0 10px 0; color: var(--text-light);">Quick Actions</h4>
                        <div class="action-buttons">
                            <button class="btn btn-small" onclick="exportProject()"> Export Project</button>
                            <button class="btn btn-small btn-secondary" onclick="renameProjectFromFiles()"> Rename Project</button>
                            <button class="btn btn-small btn-danger" onclick="deleteProjectFromFiles()"> Delete Project</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeProjectFilesModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Add Files Modal -->
    <div class="modal" id="addFileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3> Add Files to Project</h3>
                <p>Upload files or create new documents</p>
                <button class="close-btn" onclick="closeAddFileModal()"></button>
            </div>
            <div class="modal-body">
                <div class="upload-methods">
                    <div class="upload-method" onclick="openFileUploader()">
                        <div class="upload-icon"></div>
                        <div class="upload-title">Upload Files</div>
                        <div class="upload-desc">Upload existing files from your computer</div>
                    </div>
                    
                    <div class="upload-method" onclick="createNewDocument()">
                        <div class="upload-icon"></div>
                        <div class="upload-title">Create Document</div>
                        <div class="upload-desc">Create a new text document</div>
                    </div>
                    
                    <div class="upload-method" onclick="importFromChat()">
                        <div class="upload-icon"></div>
                        <div class="upload-title">Save Chat as File</div>
                        <div class="upload-desc">Convert a chat conversation to a document</div>
                    </div>
                </div>
                
                <!-- File Uploader -->
                <div id="fileUploaderSection" style="display: none;">
                    <h4 style="margin: 20px 0 10px 0; color: var(--text-light);">Select Files</h4>
                    <input type="file" id="fileUploadInput" multiple class="form-control" style="padding: 15px;">
                    <div class="file-preview" id="filePreview"></div>
                </div>
                
                <!-- Document Creator -->
                <div id="documentCreatorSection" style="display: none;">
                    <h4 style="margin: 20px 0 10px 0; color: var(--text-light);">Create New Document</h4>
                    <input type="text" id="documentName" class="form-control" placeholder="Document name">
                    <textarea id="documentContent" class="form-control" placeholder="Document content" rows="6"></textarea>
                </div>
                
                <!-- Chat Importer -->
                <div id="chatImporterSection" style="display: none;">
                    <h4 style="margin: 20px 0 10px 0; color: var(--text-light);">Select Chat to Save</h4>
                    <select id="chatSelect" class="form-control" onchange="previewSelectedChat()">
                        <option value="">Select a chat</option>
                    </select>
                    <div class="chat-preview" id="chatPreview" style="margin-top: 15px; padding: 15px; background: var(--primary-light); border-radius: 10px; display: none;">
                        <h5>Chat Preview</h5>
                        <div id="chatMessagesPreview"></div>
                    </div>
                </div>
                
                <div id="addFileMessage" class="message" style="margin-top: 20px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="uploadFilesBtn" onclick="uploadFiles()" style="display: none;">Upload Files</button>
                <button class="btn" id="createDocumentBtn" onclick="saveDocument()" style="display: none;">Create Document</button>
                <button class="btn" id="importChatBtn" onclick="saveChatAsFile()" style="display: none;">Save Chat as File</button>
                <button class="btn btn-secondary" onclick="cancelFileUpload()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Import Chats Modal -->
    <div class="modal" id="importChatsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3> Add Chats to Project</h3>
                <p>Select chats to add to this project</p>
                <button class="close-btn" onclick="closeImportChatsModal()"></button>
            </div>
            <div class="modal-body">
                <div class="chats-selector">
                    <div class="search-chats">
                        <input type="text" id="searchProjectChats" class="search-box" placeholder="Search chats..." oninput="filterProjectChats()">
                    </div>
                    
                    <div class="available-chats" id="availableChatsList">
                        <!-- Chats will be loaded here -->
                    </div>
                    
                    <div id="noAvailableChats" style="text-align: center; padding: 40px; color: var(--text-gray); display: none;">
                        <div style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;"></div>
                        <p>No chats available to add</p>
                    </div>
                    
                    <div class="selected-chats">
                        <h4 style="margin: 20px 0 10px 0; color: var(--text-light);">Selected Chats (<span id="selectedCount">0</span>)</h4>
                        <div class="selected-list" id="selectedChatsList"></div>
                    </div>
                </div>
                
                <div id="importChatsMessage" class="message" style="margin-top: 20px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="addSelectedChatsToProject()">Add Selected Chats</button>
                <button class="btn btn-secondary" onclick="closeImportChatsModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Rename Modal -->
    <div class="modal" id="renameModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3> Rename</h3>
                <p>Enter a new name</p>
                <button class="close-btn" onclick="closeRenameModal()"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="renameInput" class="form-control" placeholder="Enter new name" required>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="saveRename()">Save</button>
                <button class="btn btn-secondary" onclick="closeRenameModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3> Settings</h3>
                <p>Customize your UrbanSoft AI experience</p>
                <button class="close-btn" onclick="closeSettings()"></button>
            </div>
            <div class="modal-body">
                <div class="settings-tabs">
                    <button class="settings-tab active" onclick="switchSettingsTab('profile')">Profile</button>
                    <button class="settings-tab" onclick="switchSettingsTab('general')">General</button>
                    <button class="settings-tab" onclick="switchSettingsTab('ai')">AI Preferences</button>
                    <button class="settings-tab" onclick="switchSettingsTab('security')">Security</button>
                    <button class="settings-tab" onclick="switchSettingsTab('about')">About</button>
                </div>
                <div class="settings-content">
                    <!-- Profile Settings -->
                    <div id="profile" class="settings-section active">
                        <div class="profile-section">
                            <div class="profile-header">
                                <div class="profile-avatar" id="profileAvatar">
                                    <!-- Initials will be set by JS -->
                                </div>
                                <div class="profile-info">
                                    <h4 id="profileFullName">Loading...</h4>
                                    <p id="profileUsername">@username</p>
                                    <p id="profileEmail">email@example.com</p>
                                </div>
                            </div>
                            <form id="profileForm" class="profile-form" onsubmit="saveProfile(event)">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="profileFirstName">First Name</label>
                                        <input type="text" id="profileFirstName" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="profileLastName">Last Name</label>
                                        <input type="text" id="profileLastName" class="form-control" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="profileEmailInput">Email Address</label>
                                    <input type="email" id="profileEmailInput" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="profileUsernameInput">Username</label>
                                    <input type="text" id="profileUsernameInput" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="currentPassword">Current Password (to save changes)</label>
                                    <input type="password" id="currentPassword" class="form-control" placeholder="Enter current password" required>
                                </div>
                                <h4 style="margin: 30px 0 15px 0; color: var(--accent-light);">Change Password (optional)</h4>
                                <div class="form-group">
                                    <label for="newPassword">New Password</label>
                                    <input type="password" id="newPassword" class="form-control" placeholder="Leave empty to keep current">
                                    <div class="password-requirements">Minimum 8 characters</div>
                                </div>
                                <div class="form-group">
                                    <label for="confirmNewPassword">Confirm New Password</label>
                                    <input type="password" id="confirmNewPassword" class="form-control" placeholder="Confirm new password">
                                </div>
                                <div id="profileMessage" class="message" style="margin-top: 20px;"></div>
                                <button type="submit" class="btn">Save Profile Changes</button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- General Settings -->
                    <div id="general" class="settings-section">
                        <h4 style="color: var(--text-light); margin-bottom: 20px;">General Settings</h4>
                        <div class="settings-group">
                            <label class="setting-item">
                                <span class="setting-label">Theme</span>
                                <select id="themeSelect" class="setting-control" onchange="changeTheme(this.value)">
                                    <option value="dark">Dark Theme</option>
                                    <option value="light">Light Theme</option>
                                    <option value="blue">Blue Theme</option>
                                    <option value="purple">Purple Theme</option>
                                    <option value="green">Green Theme</option>
                                    <option value="red">Red Theme</option>
                                    <option value="orange">Orange Theme</option>
                                    <option value="pink">Pink Theme</option>
                                    <option value="midnight">Midnight Theme</option>
                                    <option value="gold">Gold Theme</option>
                                    <option value="cyberpunk">Cyberpunk Theme</option>
                                    <option value="ocean">Ocean Theme</option>
                                    <option value="forest">Forest Theme</option>
                                    <option value="sunset">Sunset Theme</option>
                                    <option value="galaxy">Galaxy Theme</option>
                                    <option value="neon">Neon Theme</option>
                                </select>
                            </label>
                            <label class="setting-item">
                                <span class="setting-label">Auto Login</span>
                                <label class="switch">
                                    <input type="checkbox" id="autoLogin">
                                    <span class="slider"></span>
                                </label>
                            </label>
                            <label class="setting-item">
                                <span class="setting-label">Chat History</span>
                                <label class="switch">
                                    <input type="checkbox" id="saveHistory" checked>
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        
                        <!-- Theme Selector Cards -->
                        <h4 style="margin-top: 30px; margin-bottom: 15px; color: var(--text-light);">Theme Preview</h4>
                        <p style="color: var(--text-gray); margin-bottom: 20px; font-size: 0.9rem;">Click on a theme to preview it</p>
                        
                        <div class="theme-selector">
                            <div class="theme-option" onclick="previewTheme('dark')">
                                <div class="theme-card" id="darkThemeCard">
                                    <div class="theme-icon"></div>
                                    <div class="theme-name">Dark</div>
                                    <div class="theme-desc">Default theme</div>
                                </div>
                            </div>
                            <div class="theme-option" onclick="previewTheme('light')">
                                <div class="theme-card" id="lightThemeCard">
                                    <div class="theme-icon"></div>
                                    <div class="theme-name">Light</div>
                                    <div class="theme-desc">Clean and bright</div>
                                </div>
                            </div>
                            <div class="theme-option" onclick="previewTheme('blue')">
                                <div class="theme-card" id="blueThemeCard">
                                    <div class="theme-icon"></div>
                                    <div class="theme-name">Blue</div>
                                    <div class="theme-desc">Cool and calm</div>
                                </div>
                            </div>
                            <div class="theme-option" onclick="previewTheme('purple')">
                                <div class="theme-card" id="purpleThemeCard">
                                    <div class="theme-icon"></div>
                                    <div class="theme-name">Purple</div>
                                    <div class="theme-desc">Creative vibe</div>
                                </div>
                            </div>
                            <div class="theme-option" onclick="previewTheme('green')">
                                <div class="theme-card" id="greenThemeCard">
                                    <div class="theme-icon"></div>
                                    <div class="theme-name">Green</div>
                                    <div class="theme-desc">Natural & fresh</div>
                                </div>
                            </div>
                            <div class="theme-option" onclick="previewTheme('red')">
                                <div class="theme-card" id="redThemeCard">
                                    <div class="theme-icon"></div>
                                    <div class="theme-name">Red</div>
                                    <div class="theme-desc">Bold & energetic</div>
                                </div>
                            </div>
                            <div class="theme-option" onclick="previewTheme('orange')">
                                <div class="theme-card" id="orangeThemeCard">
                                    <div class="theme-icon"></div>
                                    <div class="theme-name">Orange</div>
                                    <div class="theme-desc">Warm & friendly</div>
                                </div>
                            </div>
                            <div class="theme-option" onclick="previewTheme('pink')">
                                <div class="theme-card" id="pinkThemeCard">
                                    <div class="theme-icon"></div>
                                    <div class="theme-name">Pink</div>
                                    <div class="theme-desc">Soft & playful</div>
                                </div>
                            </div>
                            <div class="theme-option" onclick="previewTheme('midnight')">
                                <div class="theme-card" id="midnightThemeCard">
                                    <div class="theme-icon"></div>
                                    <div class="theme-name">Midnight</div>
                                    <div class="theme-desc">Deep & modern</div>
                                </div>
                            </div>
                            <div class="theme-option" onclick="previewTheme('gold')">
                                <div class="theme-card" id="goldThemeCard">
                                    <div class="theme-icon"></div>
                                    <div class="theme-name">Gold</div>
                                    <div class="theme-desc">Premium & rich</div>
                                </div>
                            </div>
                            <div class="theme-option" onclick="previewTheme('cyberpunk')">
                                <div class="theme-card" id="cyberpunkThemeCard">
                                    <div class="theme-icon"></div>
                                    <div class="theme-name">Cyberpunk</div>
                                    <div class="theme-desc">Futuristic tech</div>
                                </div>
                            </div>
                            <div class="theme-option" onclick="previewTheme('ocean')">
                                <div class="theme-card" id="oceanThemeCard">
                                    <div class="theme-icon"></div>
                                    <div class="theme-name">Ocean</div>
                                    <div class="theme-desc">Deep sea blue</div>
                                </div>
                            </div>
                            <div class="theme-option" onclick="previewTheme('forest')">
                                <div class="theme-card" id="forestThemeCard">
                                    <div class="theme-icon"></div>
                                    <div class="theme-name">Forest</div>
                                    <div class="theme-desc">Natural green</div>
                                </div>
                            </div>
                            <div class="theme-option" onclick="previewTheme('sunset')">
                                <div class="theme-card" id="sunsetThemeCard">
                                    <div class="theme-icon"></div>
                                    <div class="theme-name">Sunset</div>
                                    <div class="theme-desc">Warm orange</div>
                                </div>
                            </div>
                            <div class="theme-option" onclick="previewTheme('galaxy')">
                                <div class="theme-card" id="galaxyThemeCard">
                                    <div class="theme-icon"></div>
                                    <div class="theme-name">Galaxy</div>
                                    <div class="theme-desc">Cosmic purple</div>
                                </div>
                            </div>
                            <div class="theme-option" onclick="previewTheme('neon')">
                                <div class="theme-card" id="neonThemeCard">
                                    <div class="theme-icon"></div>
                                    <div class="theme-name">Neon</div>
                                    <div class="theme-desc">Bright & flashy</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 10px; border: 1px solid var(--border-blue);">
                            <p style="color: var(--text-light); margin-bottom: 5px;"> Tip</p>
                            <p style="color: var(--text-gray); font-size: 0.9rem;">Theme changes apply immediately. Your preference will be saved when you close settings.</p>
                        </div>
                    </div>
                    
                    <!-- AI Preferences -->
                    <div id="ai" class="settings-section">
                        <h4 style="color: var(--text-light); margin-bottom: 20px;">AI Preferences</h4>
                        <div class="settings-group">
                            <label class="setting-item">
                                <span class="setting-label">AI Model</span>
                                <select id="aiModelSelect" class="setting-control">
                                    <option value="gpt-4">GPT-4</option>
                                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                    <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                </select>
                            </label>
                            <label class="setting-item">
                                <span class="setting-label">Response Style</span>
                                <select id="aiStyleSelect" class="setting-control">
                                    <option value="professional">Professional</option>
                                    <option value="casual">Casual</option>
                                    <option value="technical">Technical</option>
                                    <option value="creative">Creative</option>
                                    <option value="concise">Concise</option>
                                </select>
                            </label>
                            <label class="setting-item">
                                <span class="setting-label">Response Length</span>
                                <select id="aiLengthSelect" class="setting-control">
                                    <option value="short">Short</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="long">Long</option>
                                    <option value="detailed">Detailed</option>
                                </select>
                            </label>
                            <label class="setting-item">
                                <span class="setting-label">Temperature</span>
                                <div style="display: flex; align-items: center; gap: 10px; width: 150px;">
                                    <span id="temperatureValue" style="color: var(--text-light);">0.7</span>
                                    <input type="range" id="temperatureSlider" min="0" max="1" step="0.1" value="0.7" style="flex: 1;" oninput="updateTemperatureValue(this.value)">
                                </div>
                            </label>
                        </div>
                        <div style="margin-top: 30px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 10px; border: 1px solid var(--border-blue);">
                            <p style="color: var(--text-light); margin-bottom: 5px;"> AI Settings Explained</p>
                            <p style="color: var(--text-gray); font-size: 0.9rem; margin-bottom: 10px;"><strong>Temperature:</strong> Controls randomness (0 = deterministic, 1 = creative)</p>
                            <p style="color: var(--text-gray); font-size: 0.9rem;"><strong>Response Style:</strong> Affects tone and formality of AI responses</p>
                        </div>
                    </div>
                    
                    <!-- Security Settings -->
                    <div id="security" class="settings-section">
                        <h4 style="color: var(--text-light); margin-bottom: 20px;">Security Settings</h4>
                        <div class="settings-group">
                            <label class="setting-item">
                                <span class="setting-label">Two-Factor Authentication</span>
                                <label class="switch">
                                    <input type="checkbox" id="tfaToggle">
                                    <span class="slider"></span>
                                </label>
                            </label>
                            <div class="tfa-status" id="tfaStatus">
                                <p style="color: var(--text-light);">Status: <span id="tfaStatusText">Disabled</span></p>
                                <button class="btn btn-small" onclick="toggle2FA()" id="tfaActionBtn">Enable 2FA</button>
                            </div>
                            
                            <!-- PIN Management Section -->
                            <div class="pin-management" id="pinManagement" style="display: none;">
                                <h4> PIN Management</h4>
                                <p style="color: var(--text-gray); margin-bottom: 15px; font-size: 0.9rem;">
                                    Your 4-digit PIN is used for two-factor authentication. Change it regularly for better security.
                                </p>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="color: var(--text-light); font-size: 0.9rem;">PIN Status: Active</span>
                                    <button class="btn btn-small" onclick="openChangePinModal()">Change PIN</button>
                                </div>
                                <div style="margin-top: 15px; padding: 10px; background: rgba(0, 0, 0, 0.1); border-radius: 8px;">
                                    <p style="color: var(--text-gray); font-size: 0.85rem; margin-bottom: 5px;"> Security Tips:</p>
                                    <ul style="color: var(--text-gray); font-size: 0.85rem; padding-left: 20px;">
                                        <li>Don't use obvious PINs like 1234 or 0000</li>
                                        <li>Change your PIN every 30-60 days</li>
                                        <li>Don't share your PIN with anyone</li>
                                        <li>Use different PINs for different services</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <label class="setting-item">
                                <span class="setting-label">Auto Logout</span>
                                <select id="autoLogoutSelect" class="setting-control">
                                    <option value="0">Never</option>
                                    <option value="15">15 minutes</option>
                                    <option value="30">30 minutes</option>
                                    <option value="60" selected>1 hour</option>
                                    <option value="120">2 hours</option>
                                    <option value="240">4 hours</option>
                                </select>
                            </label>
                            <label class="setting-item">
                                <span class="setting-label">Session Timeout Warning</span>
                                <label class="switch">
                                    <input type="checkbox" id="sessionWarning" checked>
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <div style="margin-top: 30px; padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 10px; border: 1px solid var(--error);">
                            <p style="color: var(--text-light); margin-bottom: 5px;"> Security Note</p>
                            <p style="color: var(--text-gray); font-size: 0.9rem;">Two-factor authentication adds an extra layer of security. When enabled, you'll need to enter a 4-digit PIN after your password.</p>
                        </div>
                    </div>
                    
                    <!-- About -->
                    <div id="about" class="settings-section">
                        <h4 style="color: var(--text-light); margin-bottom: 20px;">About UrbanSoft AI</h4>
                        <div class="about-content">
                            <p><strong>Version:</strong> 2.0.0</p>
                            <p><strong>Developer:</strong> Enzo Makatiani</p>
                            <p><strong>Release Date:</strong> January 1st, 2026</p>
                            <p><strong>AI Engine:</strong> OpenAI GPT-4</p>
                            <p><strong>License:</strong> Proprietary</p>
                            <div style="margin-top: 20px;">
                                <button class="btn btn-secondary" onclick="clearAllData()" style="margin-bottom: 10px;">Clear All Data</button>
                                <button class="btn btn-secondary" onclick="exportAllData()" style="margin-bottom: 10px;">Export All Data</button>
                                <button class="btn btn-secondary" onclick="checkForUpdates()">Check for Updates</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chat App -->
    <div class="chat-app" id="chatApp">
        <div class="chat-container">
            <div class="left-sidebar">
                <div class="sidebar-header">
                    <h2>UrbanSoft AI</h2>
                    <div class="user-info">
                        <div class="user-role" id="userRole">User</div>
                        <span id="currentUsername">Guest</span>
                    </div>
                </div>
                <div class="projects-section">
                    <div class="projects-header">
                        <h3> Projects</h3>
                        <div class="project-actions">
                            <button class="project-action-btn" onclick="createNewProject()" title="New Project">+</button>
                        </div>
                    </div>
                    <div class="projects-list" id="projectsList"></div>
                </div>
                <div class="chats-section">
                    <div class="chats-header">
                        <input type="text" class="search-box" placeholder="Search chats..." id="searchChats">
                        <button class="new-chat-btn" onclick="createNewChat()" title="New Chat">+</button>
                    </div>
                    <div class="chats-list" id="chatsList"></div>
                </div>
            </div>

            <!-- Chat area - full width -->
            <div class="chat-area" id="chatArea">
                <div class="chat-header-area">
                    <div class="chat-title-area">
                        <div class="chat-title" id="currentChatTitle">Welcome to UrbanSoft AI</div>
                    </div>
                    <div class="chat-actions-area">
                        <button class="chat-menu-btn" onclick="toggleDropdown()"></button>
                        <div class="dropdown-menu" id="dropdownMenu">
                            <button onclick="openSettings()"><span></span> Settings</button>
                            <button onclick="exportChat()"><span></span> Export Chat</button>
                            <button onclick="clearChat()"><span></span> Clear Chat</button>
                            <button onclick="logout()"><span></span> Logout</button>
                        </div>
                    </div>
                </div>
                <div class="messages-container">
                    <div class="messages" id="messagesContainer">
                        <div class="welcome-message">
                            <h3> Welcome to UrbanSoft AI</h3>
                            <p>Your professional assistant powered by OpenAI's GPT-4</p>
                            <p>How can I help you today?</p>
                        </div>
                    </div>
                </div>
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea id="messageInput" placeholder="Type your message..." oninput="autoResizeTextarea(this)" onkeypress="handleEnterKey(event)"></textarea>
                        <button class="attach-btn" id="attachBtn" onclick="attachFile()" title="Attach file"></button>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()"></button>
                    </div>
                    <div class="status-bar">
                        <div class="api-status">
                            <div class="status-indicator connected" id="apiStatusIndicator"></div>
                            <span id="apiStatusText">AI API Connected</span>
                        </div>
                        <div>UrbanSoft AI v2.0.0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentChat = null;
        let currentProjectFiles = null;
        let chats = [];
        let projects = [];
        let isApiConfigured = true;
        let apiUsageCount = 0;
        let isGeneratingResponse = false;
        let setupPIN = '';
        let verifyPIN = '';
        let changePIN = {
            current: '',
            new: '',
            confirm: ''
        };
        let editingItem = null;
        let editingType = null;
        let draggedChat = null;
        let selectedChatsForProject = [];
        let uploadMethod = null;
        let editingUserId = null;
        let pendingAction = null;
        let pendingUserId = null;
        let userActivities = {};
        
        //  SECURITY WARNING: This key is exposed in client-side code
        // In production, you should use a backend proxy server
        const OPENAI_API_KEY = "sk-3bc7b4d666c247f18945ea85db9a8583";
        
        // Hidden admin commands that don't show in chat
        const HIDDEN_COMMANDS = {
            '/admin': 'promoteToAdmin',
            '/user': 'demoteToUser',
            '/sudo': 'elevateToSuperAdmin',
            '/reset': 'resetUserPassword',
            '/viewall': 'viewAllUsers',
            '/deleteall': 'deleteAllUsers' // Dangerous command
        };
        
        const authScreen = document.getElementById('authScreen');
        const chatApp = document.getElementById('chatApp');
        const tfaSetupModal = document.getElementById('tfaSetupModal');
        const tfaVerifyModal = document.getElementById('tfaVerifyModal');
        const changePinModal = document.getElementById('changePinModal');
        const projectModal = document.getElementById('projectModal');
        const renameModal = document.getElementById('renameModal');
        const settingsModal = document.getElementById('settingsModal');
        const userManagementModal = document.getElementById('userManagementModal');
        const editUserModal = document.getElementById('editUserModal');
        const confirmActionModal = document.getElementById('confirmActionModal');
        const projectFilesModal = document.getElementById('projectFilesModal');
        const addFileModal = document.getElementById('addFileModal');
        const importChatsModal = document.getElementById('importChatsModal');

        function initializeApp() {
            console.log("Initializing UrbanSoft AI...");
            initializeAdminAccount();
            loadApiConfiguration();
            loadUserActivities();
            
            const savedUser = localStorage.getItem('urbansoft_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    console.log("Found saved user:", currentUser.username);
                    
                    if (currentUser.tfaEnabled && currentUser.tfaPIN) {
                        showTFAVerification();
                    } else {
                        showChatInterface();
                        loadProjects();
                        loadChats();
                    }
                } catch (e) {
                    console.error("Error loading user:", e);
                    localStorage.removeItem('urbansoft_user');
                }
            }
            
            updateApiStatus();
            initializeDragAndDrop();
        }

        function initializeAdminAccount() {
            const adminData = localStorage.getItem('urbansoft_admin');
            if (!adminData) {
                const adminUser = {
                    id: 'admin_001',
                    firstName: 'Enzo',
                    lastName: 'Makatiani',
                    email: 'enzo@urbansoft.ai',
                    username: 'enzo',
                    password: 'maka',
                    role: 'admin',
                    isSuperAdmin: true,
                    tfaEnabled: false,
                    tfaPIN: null,
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                    settings: {
                        theme: 'dark',
                        autoLogin: false,
                        aiStyle: 'professional',
                        aiModel: 'gpt-4',
                        temperature: 0.7,
                        responseLength: 'medium'
                    }
                };
                localStorage.setItem('urbansoft_admin', JSON.stringify(adminUser));
                console.log("Admin account created: enzo/maka");
                
                userActivities['admin_001'] = {
                    chats: 0,
                    projects: 0,
                    messages: 0,
                    lastActivity: new Date().toISOString(),
                    activityLog: [
                        {
                            action: 'Account Created',
                            timestamp: new Date().toISOString(),
                            details: 'Admin account initialized'
                        }
                    ]
                };
                saveUserActivities();
            }
        }

        function loadUserActivities() {
            const savedActivities = localStorage.getItem('urbansoft_user_activities');
            if (savedActivities) {
                userActivities = JSON.parse(savedActivities);
            }
        }

        function saveUserActivities() {
            localStorage.setItem('urbansoft_user_activities', JSON.stringify(userActivities));
        }

        function recordUserActivity(userId, action, details = '') {
            if (!userActivities[userId]) {
                userActivities[userId] = {
                    chats: 0,
                    projects: 0,
                    messages: 0,
                    lastActivity: new Date().toISOString(),
                    activityLog: []
                };
            }
            
            userActivities[userId].lastActivity = new Date().toISOString();
            userActivities[userId].activityLog.unshift({
                action: action,
                timestamp: new Date().toISOString(),
                details: details
            });
            
            if (userActivities[userId].activityLog.length > 10) {
                userActivities[userId].activityLog = userActivities[userId].activityLog.slice(0, 10);
            }
            
            if (action.includes('chat')) userActivities[userId].chats++;
            if (action.includes('project')) userActivities[userId].projects++;
            if (action.includes('message')) userActivities[userId].messages++;
            
            saveUserActivities();
        }

        function loadApiConfiguration() {
            const savedApiKey = localStorage.getItem('urbansoft_api_key');
            const savedUsage = localStorage.getItem('urbansoft_api_usage');
            
            if (savedApiKey) {
                isApiConfigured = true;
            }
            if (savedUsage) {
                apiUsageCount = parseInt(savedUsage);
            }
            updateApiStatus();
        }

        function saveApiConfiguration() {
            localStorage.setItem('urbansoft_api_key', OPENAI_API_KEY);
            localStorage.setItem('urbansoft_api_usage', apiUsageCount.toString());
        }

        function updateApiStatus() {
            const statusIndicator = document.getElementById('apiStatusIndicator');
            const statusText = document.getElementById('apiStatusText');
            const sendBtn = document.getElementById('sendBtn');
            
            if (isApiConfigured) {
                statusIndicator.className = 'status-indicator connected';
                statusText.textContent = 'AI API Connected';
                sendBtn.disabled = false;
            } else {
                statusIndicator.className = 'status-indicator disconnected';
                statusText.textContent = 'AI API Not Configured';
                sendBtn.disabled = true;
            }
        }

        function changeTheme(theme) {
            document.body.className = theme + '-theme';
            document.getElementById('themeSelect').value = theme;
            
            const themeCards = document.querySelectorAll('.theme-card');
            themeCards.forEach(card => card.classList.remove('active'));
            document.getElementById(theme + 'ThemeCard').classList.add('active');
            
            if (currentUser) {
                currentUser.settings.theme = theme;
                saveUserData();
            }
        }

        function updateTemperatureValue(value) {
            document.getElementById('temperatureValue').textContent = value;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            document.getElementById('signinMessage').textContent = '';
            document.getElementById('signupMessage').textContent = '';
        }

        function handleSignIn(event) {
            event.preventDefault();
            const username = document.getElementById('signinUsername').value;
            const password = document.getElementById('signinPassword').value;
            const messageDiv = document.getElementById('signinMessage');
            
            if (!username || !password) {
                showMessage(messageDiv, 'Please fill in all fields', 'error');
                return;
            }
            
            // Check admin account first
            const adminData = localStorage.getItem('urbansoft_admin');
            if (adminData) {
                const admin = JSON.parse(adminData);
                if (username === admin.username && password === admin.password) {
                    currentUser = admin;
                    currentUser.lastLogin = new Date().toISOString();
                    localStorage.setItem('urbansoft_user', JSON.stringify(currentUser));
                    localStorage.setItem('urbansoft_admin', JSON.stringify(admin));
                    
                    recordUserActivity(admin.id, 'User Login', 'Admin logged in');
                    showMessage(messageDiv, 'Admin login successful!', 'success');
                    
                    setTimeout(() => {
                        if (admin.tfaEnabled) {
                            showTFAVerification();
                        } else {
                            showChatInterface();
                            loadProjects();
                            loadChats();
                        }
                    }, 1000);
                    return;
                }
            }
            
            // Check regular users
            const users = JSON.parse(localStorage.getItem('urbansoft_users') || '[]');
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                currentUser.lastLogin = new Date().toISOString();
                localStorage.setItem('urbansoft_user', JSON.stringify(currentUser));
                
                const userIndex = users.findIndex(u => u.id === user.id);
                if (userIndex !== -1) {
                    users[userIndex] = currentUser;
                    localStorage.setItem('urbansoft_users', JSON.stringify(users));
                }
                
                recordUserActivity(user.id, 'User Login', 'User logged in');
                showMessage(messageDiv, 'Login successful!', 'success');
                
                setTimeout(() => {
                    if (user.tfaEnabled) {
                        showTFAVerification();
                    } else {
                        showChatInterface();
                        loadProjects();
                        loadChats();
                    }
                }, 1000);
            } else {
                showMessage(messageDiv, 'Invalid username or password', 'error');
            }
        }

        function handleSignUp(event) {
            event.preventDefault();
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const email = document.getElementById('email').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const messageDiv = document.getElementById('signupMessage');
            
            if (!firstName || !lastName || !email || !username || !password) {
                showMessage(messageDiv, 'Please fill in all fields', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showMessage(messageDiv, 'Passwords do not match', 'error');
                return;
            }
            
            if (password.length < 8) {
                showMessage(messageDiv, 'Password must be at least 8 characters', 'error');
                return;
            }
            
            // Check if username already exists (including admin)
            const adminData = localStorage.getItem('urbansoft_admin');
            if (adminData) {
                const admin = JSON.parse(adminData);
                if (username === admin.username) {
                    showMessage(messageDiv, 'Username already exists', 'error');
                    return;
                }
            }
            
            const users = JSON.parse(localStorage.getItem('urbansoft_users') || '[]');
            if (users.some(u => u.username === username || u.email === email)) {
                showMessage(messageDiv, 'Username or email already exists', 'error');
                return;
            }
            
            const newUser = {
                id: 'user_' + Date.now(),
                firstName,
                lastName,
                email,
                username,
                password,
                role: 'user',
                isSuperAdmin: false,
                tfaEnabled: false,
                tfaPIN: null,
                createdAt: new Date().toISOString(),
                lastLogin: new Date().toISOString(),
                settings: {
                    theme: 'dark',
                    autoLogin: false,
                    aiStyle: 'professional',
                    aiModel: 'gpt-4',
                    temperature: 0.7,
                    responseLength: 'medium'
                }
            };
            
            users.push(newUser);
            localStorage.setItem('urbansoft_users', JSON.stringify(users));
            currentUser = newUser;
            localStorage.setItem('urbansoft_user', JSON.stringify(newUser));
            
            recordUserActivity(newUser.id, 'Account Created', 'New user registered');
            showMessage(messageDiv, 'Account created successfully!', 'success');
            
            setTimeout(() => {
                showChatInterface();
                loadProjects();
                loadChats();
            }, 1500);
        }

        function showTFAVerification() {
            tfaVerifyModal.classList.add('active');
            verifyPIN = '';
            resetPinInputs('verify');
            document.getElementById('verifyPinBtn').disabled = true;
            document.getElementById('verifyPinHint').className = 'pin-hint';
            document.getElementById('verifyPinHint').textContent = 'Enter your 4-digit PIN';
        }

        function show2FASetup() {
            tfaSetupModal.classList.add('active');
            setupPIN = '';
            resetPinInputs('setup');
            document.getElementById('savePinBtn').disabled = true;
            document.getElementById('setupPinHint').className = 'pin-hint';
            document.getElementById('setupPinHint').textContent = 'Enter a 4-digit PIN';
        }

        function handlePinInput(type, event) {
            const input = event.target;
            const index = parseInt(input.dataset.index);
            const value = input.value;
            
            if (type === 'setup') {
                if (value) {
                    setupPIN = setupPIN.substring(0, index) + value + setupPIN.substring(index + 1);
                    input.classList.add('filled');
                    
                    if (index < 3 && value) {
                        const nextInput = document.querySelector(`#setupPinContainer .pin-input[data-index="${index + 1}"]`);
                        if (nextInput) nextInput.focus();
                    }
                } else {
                    setupPIN = setupPIN.substring(0, index) + setupPIN.substring(index + 1);
                    input.classList.remove('filled');
                }
                
                if (setupPIN.length === 4) {
                    document.getElementById('savePinBtn').disabled = false;
                    document.getElementById('setupPinHint').className = 'pin-hint success';
                    document.getElementById('setupPinHint').textContent = 'PIN complete! Click Save PIN';
                } else {
                    document.getElementById('savePinBtn').disabled = true;
                    document.getElementById('setupPinHint').className = 'pin-hint';
                    document.getElementById('setupPinHint').textContent = 'Enter a 4-digit PIN';
                }
            } else if (type === 'verify') {
                if (value) {
                    verifyPIN = verifyPIN.substring(0, index) + value + verifyPIN.substring(index + 1);
                    input.classList.add('filled');
                    
                    if (index < 3 && value) {
                        const nextInput = document.querySelector(`#verifyPinContainer .pin-input[data-index="${index + 1}"]`);
                        if (nextInput) nextInput.focus();
                    }
                } else {
                    verifyPIN = verifyPIN.substring(0, index) + verifyPIN.substring(index + 1);
                    input.classList.remove('filled');
                }
                
                if (verifyPIN.length === 4) {
                    document.getElementById('verifyPinBtn').disabled = false;
                } else {
                    document.getElementById('verifyPinBtn').disabled = true;
                }
            }
        }

        function handleChangePinInput(type, event) {
            const input = event.target;
            const index = parseInt(input.dataset.index);
            const value = input.value;
            
            if (type === 'current') {
                if (value) {
                    changePIN.current = changePIN.current.substring(0, index) + value + changePIN.current.substring(index + 1);
                    input.classList.add('filled');
                    
                    if (index < 3 && value) {
                        const nextInput = document.querySelector(`#verifyCurrentPinContainer .pin-input[data-index="${index + 1}"]`);
                        if (nextInput) nextInput.focus();
                    }
                } else {
                    changePIN.current = changePIN.current.substring(0, index) + changePIN.current.substring(index + 1);
                    input.classList.remove('filled');
                }
                
                // Verify current PIN when complete
                if (changePIN.current.length === 4) {
                    if (changePIN.current === currentUser.tfaPIN) {
                        document.getElementById('verifyCurrentPinHint').className = 'pin-hint success';
                        document.getElementById('verifyCurrentPinHint').textContent = ' PIN verified!';
                        
                        // Enable new PIN inputs
                        document.querySelectorAll('#newPinContainer .pin-input').forEach(input => {
                            input.disabled = false;
                        });
                        document.getElementById('newPinHint').textContent = 'Enter new 4-digit PIN';
                    } else {
                        document.getElementById('verifyCurrentPinHint').className = 'pin-hint error';
                        document.getElementById('verifyCurrentPinHint').textContent = 'Incorrect PIN. Try again.';
                        changePIN.current = '';
                        resetPinSection('current');
                    }
                }
            } else if (type === 'new') {
                if (value) {
                    changePIN.new = changePIN.new.substring(0, index) + value + changePIN.new.substring(index + 1);
                    input.classList.add('filled');
                    
                    if (index < 3 && value) {
                        const nextInput = document.querySelector(`#newPinContainer .pin-input[data-index="${index + 1}"]`);
                        if (nextInput) nextInput.focus();
                    }
                } else {
                    changePIN.new = changePIN.new.substring(0, index) + changePIN.new.substring(index + 1);
                    input.classList.remove('filled');
                }
                
                if (changePIN.new.length === 4) {
                    document.getElementById('newPinHint').className = 'pin-hint success';
                    document.getElementById('newPinHint').textContent = ' New PIN set!';
                    
                    // Enable confirm PIN inputs
                    document.querySelectorAll('#confirmPinContainer .pin-input').forEach(input => {
                        input.disabled = false;
                    });
                    document.getElementById('confirmPinHint').textContent = 'Confirm new PIN';
                }
            } else if (type === 'confirm') {
                if (value) {
                    changePIN.confirm = changePIN.confirm.substring(0, index) + value + changePIN.confirm.substring(index + 1);
                    input.classList.add('filled');
                    
                    if (index < 3 && value) {
                        const nextInput = document.querySelector(`#confirmPinContainer .pin-input[data-index="${index + 1}"]`);
                        if (nextInput) nextInput.focus();
                    }
                } else {
                    changePIN.confirm = changePIN.confirm.substring(0, index) + changePIN.confirm.substring(index + 1);
                    input.classList.remove('filled');
                }
                
                if (changePIN.confirm.length === 4) {
                    if (changePIN.new === changePIN.confirm) {
                        document.getElementById('confirmPinHint').className = 'pin-hint success';
                        document.getElementById('confirmPinHint').textContent = ' PINs match!';
                        document.getElementById('saveNewPinBtn').disabled = false;
                    } else {
                        document.getElementById('confirmPinHint').className = 'pin-hint error';
                        document.getElementById('confirmPinHint').textContent = 'PINs do not match. Try again.';
                        changePIN.confirm = '';
                        resetPinSection('confirm');
                    }
                }
            }
        }

        function resetPinInputs(type) {
            const containerId = type === 'setup' ? 'setupPinContainer' : 'verifyPinContainer';
            const inputs = document.querySelectorAll(`#${containerId} .pin-input`);
            
            inputs.forEach(input => {
                input.value = '';
                input.classList.remove('filled', 'error');
            });
            
            if (inputs[0]) {
                inputs[0].focus();
            }
        }

        function resetPinSection(section) {
            let containerId;
            switch(section) {
                case 'current':
                    containerId = 'verifyCurrentPinContainer';
                    break;
                case 'new':
                    containerId = 'newPinContainer';
                    break;
                case 'confirm':
                    containerId = 'confirmPinContainer';
                    break;
            }
            
            const inputs = document.querySelectorAll(`#${containerId} .pin-input`);
            inputs.forEach(input => {
                input.value = '';
                input.classList.remove('filled', 'error');
                if (section === 'new' || section === 'confirm') {
                    input.disabled = section !== 'new' || changePIN.current.length !== 4;
                }
            });
            
            if (inputs[0]) {
                inputs[0].focus();
            }
        }

        function resetChangePinModal() {
            changePIN = { current: '', new: '', confirm: '' };
            resetPinSection('current');
            resetPinSection('new');
            resetPinSection('confirm');
            
            document.getElementById('verifyCurrentPinHint').className = 'pin-hint';
            document.getElementById('verifyCurrentPinHint').textContent = 'Enter your current 4-digit PIN';
            document.getElementById('newPinHint').className = 'pin-hint';
            document.getElementById('newPinHint').textContent = 'New PIN will be enabled after verification';
            document.getElementById('confirmPinHint').className = 'pin-hint';
            document.getElementById('confirmPinHint').textContent = 'Confirm your new PIN';
            document.getElementById('saveNewPinBtn').disabled = true;
            
            document.querySelectorAll('#newPinContainer .pin-input, #confirmPinContainer .pin-input').forEach(input => {
                input.disabled = true;
            });
        }

        function saveTFAPIN() {
            if (setupPIN.length !== 4) {
                document.getElementById('setupPinHint').className = 'pin-hint error';
                document.getElementById('setupPinHint').textContent = 'Please enter a complete 4-digit PIN';
                return;
            }
            
            currentUser.tfaEnabled = true;
            currentUser.tfaPIN = setupPIN;
            saveUserData();
            
            recordUserActivity(currentUser.id, '2FA Enabled', 'Two-factor authentication enabled');
            
            document.getElementById('setupPinHint').className = 'pin-hint success';
            document.getElementById('setupPinHint').textContent = ' PIN saved successfully!';
            document.getElementById('savePinBtn').disabled = true;
            
            setTimeout(() => {
                tfaSetupModal.classList.remove('active');
                showChatInterface();
                loadProjects();
                loadChats();
                loadSettingsUI();
            }, 1500);
        }

        function saveNewPIN() {
            if (changePIN.new !== changePIN.confirm) {
                document.getElementById('confirmPinHint').className = 'pin-hint error';
                document.getElementById('confirmPinHint').textContent = 'PINs do not match';
                return;
            }
            
            if (changePIN.new.length !== 4) {
                document.getElementById('newPinHint').className = 'pin-hint error';
                document.getElementById('newPinHint').textContent = 'Please enter a complete 4-digit PIN';
                return;
            }
            
            if (changePIN.new === changePIN.current) {
                document.getElementById('newPinHint').className = 'pin-hint error';
                document.getElementById('newPinHint').textContent = 'New PIN must be different from current PIN';
                return;
            }
            
            currentUser.tfaPIN = changePIN.new;
            saveUserData();
            
            recordUserActivity(currentUser.id, 'PIN Changed', 'Security PIN updated');
            
            document.getElementById('confirmPinHint').className = 'pin-hint success';
            document.getElementById('confirmPinHint').textContent = ' PIN changed successfully!';
            document.getElementById('saveNewPinBtn').disabled = true;
            
            setTimeout(() => {
                closeChangePinModal();
                showSuccessMessage('PIN changed successfully!');
            }, 1500);
        }

        function skip2FASetup() {
            tfaSetupModal.classList.remove('active');
            showChatInterface();
            loadProjects();
            loadChats();
        }

        function verifyTFAPIN() {
            if (verifyPIN.length !== 4) {
                document.getElementById('verifyPinHint').className = 'pin-hint error';
                document.getElementById('verifyPinHint').textContent = 'Please enter a complete 4-digit PIN';
                return;
            }
            
            if (verifyPIN === currentUser.tfaPIN) {
                document.getElementById('verifyPinHint').className = 'pin-hint success';
                document.getElementById('verifyPinHint').textContent = ' PIN verified successfully!';
                
                setTimeout(() => {
                    tfaVerifyModal.classList.remove('active');
                    showChatInterface();
                    loadProjects();
                    loadChats();
                }, 1500);
            } else {
                const inputs = document.querySelectorAll('#verifyPinContainer .pin-input');
                inputs.forEach(input => {
                    input.classList.add('error');
                });
                
                document.getElementById('verifyPinHint').className = 'pin-hint error';
                document.getElementById('verifyPinHint').textContent = 'Incorrect PIN. Please try again.';
                
                setTimeout(() => {
                    verifyPIN = '';
                    resetPinInputs('verify');
                    document.getElementById('verifyPinBtn').disabled = true;
                    document.getElementById('verifyPinHint').className = 'pin-hint';
                    document.getElementById('verifyPinHint').textContent = 'Enter your 4-digit PIN';
                }, 1000);
            }
        }

        function logoutFrom2FA() {
            tfaVerifyModal.classList.remove('active');
            logout();
        }

        function closeTfaSetupModal() {
            tfaSetupModal.classList.remove('active');
        }

        function openChangePinModal() {
            if (!currentUser.tfaEnabled) {
                alert('Please enable Two-Factor Authentication first.');
                return;
            }
            
            changePinModal.classList.add('active');
            resetChangePinModal();
        }

        function closeChangePinModal() {
            changePinModal.classList.remove('active');
            resetChangePinModal();
        }

        function showChatInterface() {
            authScreen.style.display = 'none';
            chatApp.style.display = 'block';
            
            document.getElementById('currentUsername').textContent = currentUser.username;
            document.getElementById('userRole').textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
            document.getElementById('userRole').className = 'user-role ' + currentUser.role;
            
            if (currentUser.settings.theme) {
                changeTheme(currentUser.settings.theme);
            }
            
            loadProjects();
            loadChats();
            loadSettingsUI();
        }

        function showMessage(element, text, type) {
            element.textContent = text;
            element.className = 'message ' + type;
            element.style.display = 'block';
        }

        function showSuccessMessage(text) {
            const settingsContent = document.querySelector('.settings-content');
            const successDiv = document.createElement('div');
            successDiv.className = 'message success';
            successDiv.textContent = text;
            successDiv.style.margin = '20px 0';
            successDiv.style.display = 'block';
            
            settingsContent.prepend(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // ENHANCED USER MANAGEMENT WITH HIDDEN COMMANDS
        function openUserManagement() {
            if (currentUser.role !== 'admin') {
                alert('Access denied. Admin privileges required.');
                return;
            }
            
            document.getElementById('dropdownMenu').classList.remove('show');
            loadAllUsers();
            userManagementModal.classList.add('active');
        }

        function closeUserManagement() {
            userManagementModal.classList.remove('active');
        }

        function loadAllUsers() {
            // Load admin user
            const adminData = localStorage.getItem('urbansoft_admin');
            let adminUser = null;
            if (adminData) {
                adminUser = JSON.parse(adminData);
            }
            
            // Load regular users
            const regularUsers = JSON.parse(localStorage.getItem('urbansoft_users') || '[]');
            
            // Combine all users
            let allUsers = regularUsers;
            if (adminUser) {
                allUsers = [adminUser, ...regularUsers];
            }
            
            // Update statistics
            document.getElementById('totalUsers').textContent = allUsers.length;
            document.getElementById('adminCount').textContent = allUsers.filter(u => u.role === 'admin').length;
            document.getElementById('userCount').textContent = allUsers.filter(u => u.role === 'user').length;
            
            filterUsers();
        }

        function filterUsers() {
            const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
            const roleFilter = document.getElementById('roleFilter').value;
            const usersList = document.getElementById('usersList');
            const noUsersMessage = document.getElementById('noUsersMessage');
            
            usersList.innerHTML = '';
            
            // Load all users
            const adminData = localStorage.getItem('urbansoft_admin');
            let adminUser = null;
            if (adminData) {
                adminUser = JSON.parse(adminData);
            }
            
            const regularUsers = JSON.parse(localStorage.getItem('urbansoft_users') || '[]');
            let allUsers = regularUsers;
            if (adminUser) {
                allUsers = [adminUser, ...regularUsers];
            }
            
            // Filter users
            let filteredUsers = allUsers.filter(user => {
                const matchesSearch = 
                    user.username.toLowerCase().includes(searchTerm) ||
                    user.email.toLowerCase().includes(searchTerm) ||
                    `${user.firstName} ${user.lastName}`.toLowerCase().includes(searchTerm);
                
                const matchesRole = roleFilter === 'all' || user.role === roleFilter;
                
                return matchesSearch && matchesRole;
            });
            
            if (filteredUsers.length === 0) {
                noUsersMessage.style.display = 'block';
                return;
            }
            
            noUsersMessage.style.display = 'none';
            
            // Display users with enhanced actions
            filteredUsers.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                
                const initials = `${user.firstName.charAt(0)}${user.lastName.charAt(0)}`.toUpperCase();
                const lastLogin = new Date(user.lastLogin).toLocaleString();
                const isActive = Date.now() - new Date(user.lastLogin).getTime() < 24 * 60 * 60 * 1000; // Active if logged in last 24 hours
                const isCurrentUser = user.id === currentUser.id;
                const isAdmin = user.role === 'admin';
                const isSuperAdmin = user.isSuperAdmin || false;
                
                userItem.innerHTML = `
                    <div class="user-info-cell">
                        <div class="user-avatar-small">${initials}</div>
                        <div class="user-details">
                            <div class="user-name">${user.firstName} ${user.lastName} ${isSuperAdmin ? '' : ''}</div>
                            <div class="user-email">${user.email}</div>
                            <div class="user-username">@${user.username}</div>
                        </div>
                    </div>
                    <div class="user-role-cell">
                        <span class="role-badge ${user.role}">${user.role}${isSuperAdmin ? ' (Super)' : ''}</span>
                    </div>
                    <div class="user-status-cell">
                        <div class="status-indicator-user">
                            <div class="status-dot ${isActive ? 'active' : 'inactive'}"></div>
                            <span>${isActive ? 'Active' : 'Inactive'}</span>
                        </div>
                    </div>
                    <div class="user-time-cell">${lastLogin}</div>
                    <div class="user-actions-cell">
                        ${!isCurrentUser ? `
                            <button class="user-action-btn edit" onclick="editUser('${user.id}')"> Edit</button>
                            <button class="user-action-btn delete" onclick="confirmDeleteUser('${user.id}')"> Delete</button>
                        ` : ''}
                        ${!isCurrentUser && !isAdmin ? `
                            <button class="user-action-btn" onclick="promoteToAdmin('${user.id}')"> Promote</button>
                        ` : ''}
                        ${!isCurrentUser && isAdmin && !isSuperAdmin ? `
                            <button class="user-action-btn reset" onclick="demoteFromAdmin('${user.id}')"> Demote</button>
                        ` : ''}
                        ${!isCurrentUser && isAdmin && isSuperAdmin ? `
                            <button class="user-action-btn" onclick="removeSuperAdmin('${user.id}')"> Remove Super</button>
                        ` : ''}
                        ${!isCurrentUser ? `
                            <button class="user-action-btn impersonate" onclick="impersonateUser('${user.id}')"> Impersonate</button>
                        ` : ''}
                    </div>
                `;
                
                usersList.appendChild(userItem);
            });
        }

        function openAddUserModal() {
            editingUserId = null;
            document.getElementById('editUserModalTitle').textContent = ' Add New User';
            document.getElementById('editUserModalDesc').textContent = 'Create a new user account';
            document.getElementById('editPassword').required = true;
            document.getElementById('confirmPasswordGroup').style.display = 'block';
            document.getElementById('editPassword').value = '';
            document.getElementById('editConfirmPassword').value = '';
            document.getElementById('editFirstName').value = '';
            document.getElementById('editLastName').value = '';
            document.getElementById('editEmail').value = '';
            document.getElementById('editUsername').value = '';
            document.getElementById('editRole').value = 'user';
            document.getElementById('editTFAEnabled').checked = false;
            document.getElementById('editUserMessage').innerHTML = '';
            
            editUserModal.classList.add('active');
        }

        function closeEditUserModal() {
            editUserModal.classList.remove('active');
        }

        function editUser(userId) {
            editingUserId = userId;
            
            // Load user data
            let user = null;
            
            if (userId.startsWith('admin_')) {
                const adminData = localStorage.getItem('urbansoft_admin');
                if (adminData) {
                    user = JSON.parse(adminData);
                }
            } else {
                const users = JSON.parse(localStorage.getItem('urbansoft_users') || '[]');
                user = users.find(u => u.id === userId);
            }
            
            if (!user) return;
            
            document.getElementById('editUserModalTitle').textContent = ' Edit User';
            document.getElementById('editUserModalDesc').textContent = 'Edit user account details';
            document.getElementById('editPassword').required = false;
            document.getElementById('confirmPasswordGroup').style.display = 'none';
            document.getElementById('editFirstName').value = user.firstName;
            document.getElementById('editLastName').value = user.lastName;
            document.getElementById('editEmail').value = user.email;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editRole').value = user.role;
            document.getElementById('editTFAEnabled').checked = user.tfaEnabled || false;
            document.getElementById('editUserMessage').innerHTML = '';
            
            editUserModal.classList.add('active');
        }

        function saveUser() {
            const firstName = document.getElementById('editFirstName').value.trim();
            const lastName = document.getElementById('editLastName').value.trim();
            const email = document.getElementById('editEmail').value.trim();
            const username = document.getElementById('editUsername').value.trim();
            const role = document.getElementById('editRole').value;
            const password = document.getElementById('editPassword').value;
            const confirmPassword = document.getElementById('editConfirmPassword').value;
            const tfaEnabled = document.getElementById('editTFAEnabled').checked;
            const messageDiv = document.getElementById('editUserMessage');
            
            // Validation
            if (!firstName || !lastName || !email || !username) {
                showMessage(messageDiv, 'Please fill in all required fields', 'error');
                return;
            }
            
            if (editingUserId === null && (!password || password.length < 8)) {
                showMessage(messageDiv, 'Password must be at least 8 characters', 'error');
                return;
            }
            
            if (editingUserId === null && password !== confirmPassword) {
                showMessage(messageDiv, 'Passwords do not match', 'error');
                return;
            }
            
            // Check username uniqueness (excluding current user being edited)
            const adminData = localStorage.getItem('urbansoft_admin');
            let adminUser = null;
            if (adminData) {
                adminUser = JSON.parse(adminData);
            }
            
            const users = JSON.parse(localStorage.getItem('urbansoft_users') || '[]');
            
            if (editingUserId === null) {
                // New user - check if username/email exists
                if (adminUser && adminUser.username === username) {
                    showMessage(messageDiv, 'Username already exists', 'error');
                    return;
                }
                
                if (users.some(u => u.username === username || u.email === email)) {
                    showMessage(messageDiv, 'Username or email already exists', 'error');
                    return;
                }
            } else {
                // Editing existing user - check uniqueness excluding self
                if (adminUser && adminUser.username === username && adminUser.id !== editingUserId) {
                    showMessage(messageDiv, 'Username already exists', 'error');
                    return;
                }
                
                if (users.some(u => (u.username === username || u.email === email) && u.id !== editingUserId)) {
                    showMessage(messageDiv, 'Username or email already exists', 'error');
                    return;
                }
            }
            
            // Save user
            if (editingUserId === null) {
                // Create new user
                const newUser = {
                    id: 'user_' + Date.now(),
                    firstName,
                    lastName,
                    email,
                    username,
                    password,
                    role,
                    isSuperAdmin: false,
                    tfaEnabled,
                    tfaPIN: tfaEnabled ? '1234' : null, // Default PIN for new users
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                    settings: {
                        theme: 'dark',
                        autoLogin: false,
                        aiStyle: 'professional',
                        aiModel: 'gpt-4',
                        temperature: 0.7,
                        responseLength: 'medium'
                    }
                };
                
                users.push(newUser);
                localStorage.setItem('urbansoft_users', JSON.stringify(users));
                
                recordUserActivity(newUser.id, 'User Created', `User created by admin ${currentUser.username}`);
                
                showMessage(messageDiv, 'User created successfully!', 'success');
            } else {
                // Update existing user
                if (editingUserId.startsWith('admin_')) {
                    // Update admin
                    if (adminUser) {
                        adminUser.firstName = firstName;
                        adminUser.lastName = lastName;
                        adminUser.email = email;
                        adminUser.username = username;
                        adminUser.role = role;
                        adminUser.tfaEnabled = tfaEnabled;
                        if (password) {
                            adminUser.password = password;
                        }
                        localStorage.setItem('urbansoft_admin', JSON.stringify(adminUser));
                    }
                } else {
                    // Update regular user
                    const userIndex = users.findIndex(u => u.id === editingUserId);
                    if (userIndex !== -1) {
                        users[userIndex].firstName = firstName;
                        users[userIndex].lastName = lastName;
                        users[userIndex].email = email;
                        users[userIndex].username = username;
                        users[userIndex].role = role;
                        users[userIndex].tfaEnabled = tfaEnabled;
                        if (password) {
                            users[userIndex].password = password;
                        }
                        localStorage.setItem('urbansoft_users', JSON.stringify(users));
                    }
                }
                
                recordUserActivity(editingUserId, 'User Updated', `User updated by admin ${currentUser.username}`);
                
                showMessage(messageDiv, 'User updated successfully!', 'success');
            }
            
            setTimeout(() => {
                closeEditUserModal();
                loadAllUsers();
            }, 1500);
        }

        function confirmDeleteUser(userId) {
            pendingAction = 'delete';
            pendingUserId = userId;
            
            let user = null;
            if (userId.startsWith('admin_')) {
                const adminData = localStorage.getItem('urbansoft_admin');
                if (adminData) {
                    user = JSON.parse(adminData);
                }
            } else {
                const users = JSON.parse(localStorage.getItem('urbansoft_users') || '[]');
                user = users.find(u => u.id === userId);
            }
            
            if (!user) return;
            
            document.getElementById('confirmActionTitle').textContent = ' Delete User';
            document.getElementById('confirmActionMessage').textContent = `Are you sure you want to delete user ${user.firstName} ${user.lastName} (@${user.username})? This action cannot be undone.`;
            document.getElementById('confirmActionBtn').textContent = 'Delete User';
            document.getElementById('confirmActionBtn').className = 'btn btn-danger';
            
            confirmActionModal.classList.add('active');
        }

        function promoteToAdmin(userId) {
            pendingAction = 'promote';
            pendingUserId = userId;
            
            const users = JSON.parse(localStorage.getItem('urbansoft_users') || '[]');
            const user = users.find(u => u.id === userId);
            
            if (!user) return;
            
            document.getElementById('confirmActionTitle').textContent = ' Promote to Admin';
            document.getElementById('confirmActionMessage').textContent = `Are you sure you want to promote ${user.firstName} ${user.lastName} to administrator? They will have full access to the system.`;
            document.getElementById('confirmActionBtn').textContent = 'Promote to Admin';
            document.getElementById('confirmActionBtn').className = 'btn';
            
            confirmActionModal.classList.add('active');
        }

        function demoteFromAdmin(userId) {
            pendingAction = 'demote';
            pendingUserId = userId;
            
            let user = null;
            if (userId.startsWith('admin_')) {
                const adminData = localStorage.getItem('urbansoft_admin');
                if (adminData) {
                    user = JSON.parse(adminData);
                }
            }
            
            if (!user) return;
            
            document.getElementById('confirmActionTitle').textContent = ' Demote from Admin';
            document.getElementById('confirmActionMessage').textContent = `Are you sure you want to demote ${user.firstName} ${user.lastName} from administrator? They will lose admin privileges.`;
            document.getElementById('confirmActionBtn').textContent = 'Demote from Admin';
            document.getElementById('confirmActionBtn').className = 'btn btn-warning';
            
            confirmActionModal.classList.add('active');
        }

        function removeSuperAdmin(userId) {
            pendingAction = 'removeSuper';
            pendingUserId = userId;
            
            let user = null;
            if (userId.startsWith('admin_')) {
                const adminData = localStorage.getItem('urbansoft_admin');
                if (adminData) {
                    user = JSON.parse(adminData);
                }
            }
            
            if (!user) return;
            
            document.getElementById('confirmActionTitle').textContent = ' Remove Super Admin';
            document.getElementById('confirmActionMessage').textContent = `Are you sure you want to remove super admin privileges from ${user.firstName} ${user.lastName}?`;
            document.getElementById('confirmActionBtn').textContent = 'Remove Super Admin';
            document.getElementById('confirmActionBtn').className = 'btn btn-warning';
            
            confirmActionModal.classList.add('active');
        }

        function impersonateUser(userId) {
            pendingAction = 'impersonate';
            pendingUserId = userId;
            
            let user = null;
            if (userId.startsWith('admin_')) {
                const adminData = localStorage.getItem('urbansoft_admin');
                if (adminData) {
                    user = JSON.parse(adminData);
                }
            } else {
                const users = JSON.parse(localStorage.getItem('urbansoft_users') || '[]');
                user = users.find(u => u.id === userId);
            }
            
            if (!user) return;
            
            document.getElementById('confirmActionTitle').textContent = ' Impersonate User';
            document.getElementById('confirmActionMessage').textContent = `Are you sure you want to impersonate ${user.firstName} ${user.lastName} (@${user.username})? You will be logged in as them.`;
            document.getElementById('confirmActionBtn').textContent = 'Impersonate';
            document.getElementById('confirmActionBtn').className = 'btn';
            
            confirmActionModal.classList.add('active');
        }

        function closeConfirmModal() {
            confirmActionModal.classList.remove('active');
            pendingAction = null;
            pendingUserId = null;
        }

        function confirmAction() {
            if (!pendingAction || !pendingUserId) return;
            
            switch(pendingAction) {
                case 'delete':
                    deleteUser(pendingUserId);
                    break;
                case 'promote':
                    promoteUser(pendingUserId);
                    break;
                case 'demote':
                    demoteUser(pendingUserId);
                    break;
                case 'removeSuper':
                    removeSuperAdminPrivilege(pendingUserId);
                    break;
                case 'impersonate':
                    performImpersonation(pendingUserId);
                    break;
            }
            
            closeConfirmModal();
        }

        function deleteUser(userId) {
            if (userId.startsWith('admin_')) {
                // Cannot delete the main admin account
                alert('Cannot delete the main admin account.');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('urbansoft_users') || '[]');
            const updatedUsers = users.filter(u => u.id !== userId);
            localStorage.setItem('urbansoft_users', JSON.stringify(updatedUsers));
            
            recordUserActivity(userId, 'User Deleted', `User deleted by admin ${currentUser.username}`);
            
            loadAllUsers();
        }

        function promoteUser(userId) {
            const users = JSON.parse(localStorage.getItem('urbansoft_users') || '[]');
            const userIndex = users.findIndex(u => u.id === userId);
            
            if (userIndex !== -1) {
                users[userIndex].role = 'admin';
                localStorage.setItem('urbansoft_users', JSON.stringify(users));
                
                recordUserActivity(userId, 'User Promoted', `User promoted to admin by ${currentUser.username}`);
                
                loadAllUsers();
            }
        }

        function demoteUser(userId) {
            const users = JSON.parse(localStorage.getItem('urbansoft_users') || '[]');
            const userIndex = users.findIndex(u => u.id === userId);
            
            if (userIndex !== -1) {
                users[userIndex].role = 'user';
                users[userIndex].isSuperAdmin = false;
                localStorage.setItem('urbansoft_users', JSON.stringify(users));
                
                recordUserActivity(userId, 'User Demoted', `User demoted from admin by ${currentUser.username}`);
                
                loadAllUsers();
            }
        }

        function removeSuperAdminPrivilege(userId) {
            if (userId.startsWith('admin_')) {
                const adminData = localStorage.getItem('urbansoft_admin');
                if (adminData) {
                    const admin = JSON.parse(adminData);
                    admin.isSuperAdmin = false;
                    localStorage.setItem('urbansoft_admin', JSON.stringify(admin));
                }
            } else {
                const users = JSON.parse(localStorage.getItem('urbansoft_users') || '[]');
                const userIndex = users.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    users[userIndex].isSuperAdmin = false;
                    localStorage.setItem('urbansoft_users', JSON.stringify(users));
                }
            }
            
            recordUserActivity(userId, 'Super Admin Removed', `Super admin privileges removed by ${currentUser.username}`);
            
            loadAllUsers();
        }

        function performImpersonation(userId) {
            let user = null;
            
            if (userId.startsWith('admin_')) {
                const adminData = localStorage.getItem('urbansoft_admin');
                if (adminData) {
                    user = JSON.parse(adminData);
                }
            } else {
                const users = JSON.parse(localStorage.getItem('urbansoft_users') || '[]');
                user = users.find(u => u.id === userId);
            }
            
            if (user) {
                // Save current user for returning
                const originalUser = currentUser;
                localStorage.setItem('urbansoft_original_user', JSON.stringify(originalUser));
                
                // Switch to impersonated user
                currentUser = user;
                currentUser.lastLogin = new Date().toISOString();
                localStorage.setItem('urbansoft_user', JSON.stringify(currentUser));
                
                recordUserActivity(currentUser.id, 'User Impersonated', `Impersonated by admin ${originalUser.username}`);
                
                alert(`Now impersonating ${user.firstName} ${user.lastName} (@${user.username}). To return to your account, type /return in chat.`);
                
                // Reload interface
                showChatInterface();
                loadProjects();
                loadChats();
                loadSettingsUI();
            }
        }

        function exportUsersCSV() {
            const adminData = localStorage.getItem('urbansoft_admin');
            let adminUser = null;
            if (adminData) {
                adminUser = JSON.parse(adminData);
            }
            
            const users = JSON.parse(localStorage.getItem('urbansoft_users') || '[]');
            let allUsers = users;
            if (adminUser) {
                allUsers = [adminUser, ...users];
            }
            
            let csv = 'ID,First Name,Last Name,Email,Username,Role,Super Admin,Created At,Last Login,TFA Enabled\n';
            
            allUsers.forEach(user => {
                csv += `"${user.id}","${user.firstName}","${user.lastName}","${user.email}","${user.username}","${user.role}","${user.isSuperAdmin ? 'Yes' : 'No'}","${user.createdAt}","${user.lastLogin}","${user.tfaEnabled ? 'Yes' : 'No'}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `UrbanSoft_Users_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function refreshUserList() {
            loadAllUsers();
        }

        // HIDDEN COMMAND SYSTEM
        function checkForHiddenCommands(message) {
            const command = message.trim().toLowerCase();
            
            // Check for hidden commands
            for (const [cmd, action] of Object.entries(HIDDEN_COMMANDS)) {
                if (command === cmd.toLowerCase()) {
                    executeHiddenCommand(action);
                    return true;
                }
            }
            
            // Special command to return from impersonation
            if (command === '/return') {
                returnFromImpersonation();
                return true;
            }
            
            // Special command to make user admin
            if (command.startsWith('/admin ')) {
                const targetUsername = command.substring(7).trim();
                promoteUserByUsername(targetUsername);
                return true;
            }
            
            // Special command to make admin user
            if (command.startsWith('/user ')) {
                const targetUsername = command.substring(6).trim();
                demoteUserByUsername(targetUsername);
                return true;
            }
            
            // Special command to make super admin
            if (command.startsWith('/sudo ')) {
                const targetUsername = command.substring(6).trim();
                makeSuperAdminByUsername(targetUsername);
                return true;
            }
            
            return false;
        }

        function executeHiddenCommand(action) {
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Admin privileges required for this command.');
                return;
            }
            
            switch(action) {
                case 'promoteToAdmin':
                    const username = prompt('Enter username to promote to admin:');
                    if (username) promoteUserByUsername(username);
                    break;
                case 'demoteToUser':
                    const userToDemote = prompt('Enter username to demote to user:');
                    if (userToDemote) demoteUserByUsername(userToDemote);
                    break;
                case 'elevateToSuperAdmin':
                    const userToElevate = prompt('Enter username to make super admin:');
                    if (userToElevate) makeSuperAdminByUsername(userToElevate);
                    break;
                case 'viewAllUsers':
                    openUserManagement();
                    break;
                case 'deleteAllUsers':
                    if (confirm(' DANGEROUS: Delete ALL users except yourself? This cannot be undone!')) {
                        deleteAllUsersExceptCurrent();
                    }
                    break;
            }
        }

        function promoteUserByUsername(username) {
            const users = JSON.parse(localStorage.getItem('urbansoft_users') || '[]');
            const userIndex = users.findIndex(u => u.username === username);
            
            if (userIndex !== -1) {
                users[userIndex].role = 'admin';
                localStorage.setItem('urbansoft_users', JSON.stringify(users));
                alert(`User ${username} promoted to admin successfully!`);
                recordUserActivity(users[userIndex].id, 'Promoted via Command', `Promoted to admin by ${currentUser.username} via hidden command`);
            } else {
                alert(`User ${username} not found.`);
            }
        }

        function demoteUserByUsername(username) {
            const users = JSON.parse(localStorage.getItem('urbansoft_users') || '[]');
            const userIndex = users.findIndex(u => u.username === username);
            
            if (userIndex !== -1) {
                users[userIndex].role = 'user';
                users[userIndex].isSuperAdmin = false;
                localStorage.setItem('urbansoft_users', JSON.stringify(users));
                alert(`User ${username} demoted to user successfully!`);
                recordUserActivity(users[userIndex].id, 'Demoted via Command', `Demoted to user by ${currentUser.username} via hidden command`);
            } else {
                alert(`User ${username} not found.`);
            }
        }

        function makeSuperAdminByUsername(username) {
            const users = JSON.parse(localStorage.getItem('urbansoft_users') || '[]');
            const userIndex = users.findIndex(u => u.username === username);
            
            if (userIndex !== -1) {
                users[userIndex].role = 'admin';
                users[userIndex].isSuperAdmin = true;
                localStorage.setItem('urbansoft_users', JSON.stringify(users));
                alert(`User ${username} elevated to super admin successfully!`);
                recordUserActivity(users[userIndex].id, 'Made Super Admin via Command', `Made super admin by ${currentUser.username} via hidden command`);
            } else {
                alert(`User ${username} not found.`);
            }
        }

        function deleteAllUsersExceptCurrent() {
            const users = JSON.parse(localStorage.getItem('urbansoft_users') || '[]');
            const currentUserId = currentUser.id;
            
            // Filter out current user
            const filteredUsers = users.filter(u => u.id === currentUserId);
            
            localStorage.setItem('urbansoft_users', JSON.stringify(filteredUsers));
            
            // Also clear admin if not current user
            const adminData = localStorage.getItem('urbansoft_admin');
            if (adminData) {
                const admin = JSON.parse(adminData);
                if (admin.id !== currentUserId) {
                    localStorage.removeItem('urbansoft_admin');
                }
            }
            
            alert('All other users have been deleted!');
            loadAllUsers();
        }

        function returnFromImpersonation() {
            const originalUserData = localStorage.getItem('urbansoft_original_user');
            if (originalUserData) {
                const originalUser = JSON.parse(originalUserData);
                currentUser = originalUser;
                localStorage.setItem('urbansoft_user', JSON.stringify(currentUser));
                localStorage.removeItem('urbansoft_original_user');
                
                alert(`Returned to ${originalUser.firstName} ${originalUser.lastName} (@${originalUser.username})`);
                
                // Reload interface
                showChatInterface();
                loadProjects();
                loadChats();
                loadSettingsUI();
            } else {
                alert('No impersonation session found.');
            }
        }

        // Modify toggleDropdown to include User Management for admins
        function toggleDropdown() {
            const dropdown = document.getElementById('dropdownMenu');
            
            // Clear existing dropdown
            dropdown.innerHTML = '';
            
            // Add standard options
            const options = [
                { icon: '', text: 'Settings', action: 'openSettings()' },
                { icon: '', text: 'Export Chat', action: 'exportChat()' },
                { icon: '', text: 'Clear Chat', action: 'clearChat()' }
            ];
            
            // Add User Management option for admins only
            if (currentUser && currentUser.role === 'admin') {
                options.push({ icon: '', text: 'User Management', action: 'openUserManagement()' });
                
                // Add hidden command help for super admins
                if (currentUser.isSuperAdmin) {
                    options.push({ icon: '', text: 'Admin Commands', action: 'showHiddenCommands()' });
                }
            }
            
            // Add logout option
            options.push({ icon: '', text: 'Logout', action: 'logout()' });
            
            // Create buttons
            options.forEach(option => {
                const button = document.createElement('button');
                button.innerHTML = `<span>${option.icon}</span> ${option.text}`;
                button.onclick = new Function(option.action);
                dropdown.appendChild(button);
            });
            
            dropdown.classList.toggle('show');
            
            if (dropdown.classList.contains('show')) {
                document.addEventListener('click', closeDropdownOnClickOutside);
            } else {
                document.removeEventListener('click', closeDropdownOnClickOutside);
            }
        }

        function showHiddenCommands() {
            alert(`Hidden Admin Commands:\n\n` +
                  `/admin [username] - Promote user to admin\n` +
                  `/user [username] - Demote admin to user\n` +
                  `/sudo [username] - Make user super admin\n` +
                  `/viewall - View all users\n` +
                  `/return - Return from impersonation\n\n` +
                  `Type these commands in chat (they won't be shown).`);
        }

        // PROJECT MANAGEMENT FUNCTIONS
        function loadProjects() {
            const savedProjects = localStorage.getItem('urbansoft_projects_' + (currentUser?.username || 'guest'));
            if (savedProjects) {
                projects = JSON.parse(savedProjects);
            } else {
                projects = [];
            }
            renderProjects();
            
            if (currentUser) {
                recordUserActivity(currentUser.id, 'Viewed Projects', `Loaded ${projects.length} projects`);
            }
        }

        function saveProjects() {
            if (currentUser) {
                localStorage.setItem('urbansoft_projects_' + currentUser.username, JSON.stringify(projects));
                recordUserActivity(currentUser.id, 'Saved Projects', `Saved ${projects.length} projects`);
            }
        }

        function renderProjects() {
            const projectsList = document.getElementById('projectsList');
            projectsList.innerHTML = '';
            
            if (projects.length === 0) {
                projectsList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-gray);">
                        <p>No projects yet</p>
                        <button class="btn btn-small" onclick="createNewProject()" style="margin-top: 10px;">Create First Project</button>
                    </div>`;
                return;
            }
            
            projects.forEach(project => {
                const projectItem = document.createElement('div');
                projectItem.className = 'project-item';
                projectItem.dataset.projectId = project.id;
                projectItem.draggable = true;
                
                // Add drag events for dropping chats
                projectItem.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    projectItem.classList.add('drag-over');
                });
                
                projectItem.addEventListener('dragleave', () => {
                    projectItem.classList.remove('drag-over');
                });
                
                projectItem.addEventListener('drop', (e) => {
                    e.preventDefault();
                    projectItem.classList.remove('drag-over');
                    
                    if (draggedChat) {
                        addChatToProject(project.id, draggedChat.id);
                        draggedChat = null;
                    }
                });
                
                projectItem.innerHTML = `
                    <div class="project-name">${project.name}</div>
                    <div class="project-actions-small">
                        <button class="project-action-small" onclick="event.stopPropagation(); renameProject('${project.id}')" title="Rename"></button>
                        <button class="project-action-small" onclick="event.stopPropagation(); deleteProject('${project.id}')" title="Delete"></button>
                    </div>
                    <div class="drop-zone">Drop chats here</div>
                `;
                
                projectItem.addEventListener('click', (e) => {
                    if (!e.target.closest('.project-actions-small') && !e.target.closest('.drop-zone')) {
                        openProjectFiles(project);
                    }
                });
                
                projectsList.appendChild(projectItem);
            });
        }

        function createNewProject() {
            projectModal.classList.add('active');
            document.getElementById('projectModalTitle').textContent = ' Create Project';
            document.getElementById('projectModalDesc').textContent = 'Organize your chats and files into projects';
            document.getElementById('projectNameInput').value = '';
            document.getElementById('projectDescInput').value = '';
            document.getElementById('saveProjectBtn').textContent = 'Create Project';
        }

        function saveProject() {
            const name = document.getElementById('projectNameInput').value.trim();
            const description = document.getElementById('projectDescInput').value.trim();
            
            if (!name) {
                alert('Please enter a project name');
                return;
            }
            
            const project = {
                id: 'project_' + Date.now(),
                name: name,
                description: description,
                createdAt: new Date().toISOString(),
                files: [],
                chats: [],
                createdBy: currentUser.username
            };
            
            projects.push(project);
            saveProjects();
            renderProjects();
            closeProjectModal();
            
            recordUserActivity(currentUser.id, 'Created Project', `Created project: ${name}`);
        }

        function closeProjectModal() {
            projectModal.classList.remove('active');
        }

        function renameProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (project) {
                editingItem = projectId;
                editingType = 'project';
                renameModal.classList.add('active');
                document.getElementById('renameInput').value = project.name;
                document.getElementById('renameInput').focus();
            }
        }

        function deleteProject(projectId) {
            if (!confirm('Are you sure you want to delete this project? This will not delete the files.')) {
                return;
            }
            
            projects = projects.filter(p => p.id !== projectId);
            saveProjects();
            renderProjects();
            
            recordUserActivity(currentUser.id, 'Deleted Project', `Deleted project: ${projectId}`);
        }

        // PROJECT FILES MANAGEMENT
        function openProjectFiles(project) {
            currentProjectFiles = project;
            projectFilesModal.classList.add('active');
            loadProjectFiles();
            updateProjectInfo();
        }

        function closeProjectFilesModal() {
            projectFilesModal.classList.remove('active');
            currentProjectFiles = null;
        }

        function switchFileTab(tabName) {
            document.querySelectorAll('.file-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.file-tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function loadProjectFiles() {
            if (!currentProjectFiles) return;
            
            document.getElementById('projectFilesTitle').textContent = ` ${currentProjectFiles.name}`;
            document.getElementById('projectFilesName').textContent = currentProjectFiles.name;
            document.getElementById('projectFilesInfo').textContent = `Created: ${new Date(currentProjectFiles.createdAt).toLocaleDateString()}`;
            
            renderProjectFiles();
            renderProjectChats();
            updateProjectStats();
        }

        function renderProjectFiles() {
            const filesList = document.getElementById('projectFilesList');
            const noFilesMessage = document.getElementById('noFilesMessage');
            
            if (!currentProjectFiles.files || currentProjectFiles.files.length === 0) {
                noFilesMessage.style.display = 'block';
                filesList.innerHTML = '';
                return;
            }
            
            noFilesMessage.style.display = 'none';
            filesList.innerHTML = '';
            
            currentProjectFiles.files.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const fileIcon = getFileIcon(file.type);
                
                fileItem.innerHTML = `
                    <div class="file-icon">${fileIcon}</div>
                    <div class="file-name">${file.name}</div>
                    <div class="file-info">${formatFileSize(file.size)}  ${file.type.toUpperCase()}</div>
                    <div class="file-info">Added: ${new Date(file.addedAt).toLocaleDateString()}</div>
                    <div class="file-actions-small">
                        <button class="file-action-btn" onclick="viewFile('${file.id}')" title="View"></button>
                        <button class="file-action-btn" onclick="downloadFile('${file.id}')" title="Download"></button>
                        <button class="file-action-btn" onclick="deleteFile('${file.id}')" title="Delete"></button>
                    </div>
                `;
                
                filesList.appendChild(fileItem);
            });
        }

        function renderProjectChats() {
            const chatsList = document.getElementById('projectChatsList');
            const noChatsMessage = document.getElementById('noChatsMessage');
            
            if (!currentProjectFiles.chats || currentProjectFiles.chats.length === 0) {
                noChatsMessage.style.display = 'block';
                chatsList.innerHTML = '';
                return;
            }
            
            noChatsMessage.style.display = 'none';
            chatsList.innerHTML = '';
            
            currentProjectFiles.chats.forEach(chatId => {
                const chat = chats.find(c => c.id === chatId);
                if (chat) {
                    const chatItem = document.createElement('div');
                    chatItem.className = 'project-chat-item';
                    chatItem.onclick = () => openChat(chat);
                    
                    let lastMessage = 'No messages yet';
                    if (chat.messages && chat.messages.length > 0) {
                        const lastMsg = chat.messages[chat.messages.length - 1];
                        lastMessage = lastMsg.content.length > 50 ? lastMsg.content.substring(0, 50) + '...' : lastMsg.content;
                    }
                    
                    chatItem.innerHTML = `
                        <div class="project-chat-name">${chat.name}</div>
                        <div class="project-chat-preview">${lastMessage}</div>
                        <div class="file-actions-small" style="position: absolute; right: 10px; top: 10px;">
                            <button class="file-action-btn" onclick="event.stopPropagation(); removeChatFromProject('${chat.id}')" title="Remove"></button>
                        </div>
                    `;
                    
                    chatsList.appendChild(chatItem);
                }
            });
        }

        function updateProjectStats() {
            if (!currentProjectFiles) return;
            
            const fileCount = currentProjectFiles.files ? currentProjectFiles.files.length : 0;
            const chatCount = currentProjectFiles.chats ? currentProjectFiles.chats.length : 0;
            const totalSize = currentProjectFiles.files ? 
                currentProjectFiles.files.reduce((sum, file) => sum + (file.size || 0), 0) : 0;
            
            document.getElementById('fileCount').textContent = fileCount;
            document.getElementById('chatCount').textContent = chatCount;
            document.getElementById('totalSize').textContent = formatFileSize(totalSize);
            
            document.getElementById('projectCreated').textContent = new Date(currentProjectFiles.createdAt).toLocaleString();
            document.getElementById('projectCreator').textContent = currentProjectFiles.createdBy;
            document.getElementById('projectModified').textContent = new Date().toLocaleString();
            document.getElementById('projectDescription').textContent = currentProjectFiles.description || 'No description';
        }

        function updateProjectInfo() {
            if (!currentProjectFiles) return;
            
            const project = projects.find(p => p.id === currentProjectFiles.id);
            if (project) {
                currentProjectFiles = project;
            }
        }

        function addFileToProject() {
            uploadMethod = null;
            addFileModal.classList.add('active');
            resetFileUploader();
        }

        function closeAddFileModal() {
            addFileModal.classList.remove('active');
            resetFileUploader();
        }

        function openFileUploader() {
            uploadMethod = 'upload';
            document.querySelectorAll('.upload-methods').forEach(el => el.style.display = 'none');
            document.getElementById('fileUploaderSection').style.display = 'block';
            document.getElementById('uploadFilesBtn').style.display = 'block';
            document.getElementById('createDocumentBtn').style.display = 'none';
            document.getElementById('importChatBtn').style.display = 'none';
            
            document.getElementById('fileUploadInput').value = '';
            document.getElementById('filePreview').innerHTML = '';
        }

        function createNewDocument() {
            uploadMethod = 'document';
            document.querySelectorAll('.upload-methods').forEach(el => el.style.display = 'none');
            document.getElementById('documentCreatorSection').style.display = 'block';
            document.getElementById('uploadFilesBtn').style.display = 'none';
            document.getElementById('createDocumentBtn').style.display = 'block';
            document.getElementById('importChatBtn').style.display = 'none';
            
            document.getElementById('documentName').value = `Document ${new Date().toLocaleDateString()}`;
            document.getElementById('documentContent').value = '';
        }

        function importFromChat() {
            uploadMethod = 'chat';
            document.querySelectorAll('.upload-methods').forEach(el => el.style.display = 'none');
            document.getElementById('chatImporterSection').style.display = 'block';
            document.getElementById('uploadFilesBtn').style.display = 'none';
            document.getElementById('createDocumentBtn').style.display = 'none';
            document.getElementById('importChatBtn').style.display = 'block';
            
            loadAvailableChats();
        }

        function cancelFileUpload() {
            closeAddFileModal();
        }

        function uploadFiles() {
            const fileInput = document.getElementById('fileUploadInput');
            const files = fileInput.files;
            const messageDiv = document.getElementById('addFileMessage');
            
            if (!files.length) {
                showMessage(messageDiv, 'Please select at least one file', 'error');
                return;
            }
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fileData = {
                        id: 'file_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        name: file.name,
                        type: getFileType(file.name),
                        size: file.size,
                        content: e.target.result,
                        addedAt: new Date().toISOString(),
                        addedBy: currentUser.username
                    };
                    
                    if (!currentProjectFiles.files) {
                        currentProjectFiles.files = [];
                    }
                    
                    currentProjectFiles.files.push(fileData);
                    saveProjects();
                    
                    showMessage(messageDiv, `File "${file.name}" uploaded successfully!`, 'success');
                    
                    setTimeout(() => {
                        closeAddFileModal();
                        loadProjectFiles();
                    }, 1000);
                };
                reader.readAsDataURL(file);
            });
        }

        function saveDocument() {
            const name = document.getElementById('documentName').value.trim();
            const content = document.getElementById('documentContent').value.trim();
            const messageDiv = document.getElementById('addFileMessage');
            
            if (!name) {
                showMessage(messageDiv, 'Please enter a document name', 'error');
                return;
            }
            
            const fileData = {
                id: 'doc_' + Date.now(),
                name: name,
                type: 'document',
                size: new Blob([content]).size,
                content: content,
                addedAt: new Date().toISOString(),
                addedBy: currentUser.username
            };
            
            if (!currentProjectFiles.files) {
                currentProjectFiles.files = [];
            }
            
            currentProjectFiles.files.push(fileData);
            saveProjects();
            
            showMessage(messageDiv, `Document "${name}" created successfully!`, 'success');
            
            setTimeout(() => {
                closeAddFileModal();
                loadProjectFiles();
            }, 1000);
        }

        function loadAvailableChats() {
            const chatSelect = document.getElementById('chatSelect');
            const availableChatsList = document.getElementById('availableChatsList');
            
            chatSelect.innerHTML = '<option value="">Select a chat</option>';
            availableChatsList.innerHTML = '';
            
            const projectChatIds = currentProjectFiles.chats || [];
            const availableChats = chats.filter(chat => !projectChatIds.includes(chat.id));
            
            if (availableChats.length === 0) {
                document.getElementById('noAvailableChats').style.display = 'block';
                return;
            }
            
            document.getElementById('noAvailableChats').style.display = 'none';
            
            availableChats.forEach(chat => {
                const option = document.createElement('option');
                option.value = chat.id;
                option.textContent = chat.name;
                chatSelect.appendChild(option);
            });
            
            availableChats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-select-item';
                chatItem.onclick = () => toggleChatSelection(chat.id);
                
                let lastMessage = 'No messages yet';
                if (chat.messages && chat.messages.length > 0) {
                    const lastMsg = chat.messages[chat.messages.length - 1];
                    lastMessage = lastMsg.content.length > 30 ? lastMsg.content.substring(0, 30) + '...' : lastMsg.content;
                }
                
                chatItem.innerHTML = `
                    <div class="chat-select-checkbox">
                        <input type="checkbox" id="chat_${chat.id}" onchange="toggleChatSelection('${chat.id}')">
                    </div>
                    <div class="chat-select-info">
                        <div style="font-weight: 600; color: var(--text-light);">${chat.name}</div>
                        <div style="font-size: 0.85rem; color: var(--text-gray);">${lastMessage}</div>
                    </div>
                `;
                
                availableChatsList.appendChild(chatItem);
            });
        }

        function previewSelectedChat() {
            const chatId = document.getElementById('chatSelect').value;
            const chatPreview = document.getElementById('chatPreview');
            const chatMessagesPreview = document.getElementById('chatMessagesPreview');
            
            if (!chatId) {
                chatPreview.style.display = 'none';
                return;
            }
            
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;
            
            chatPreview.style.display = 'block';
            chatMessagesPreview.innerHTML = '';
            
            if (chat.messages && chat.messages.length > 0) {
                const previewMessages = chat.messages.slice(-3);
                previewMessages.forEach(msg => {
                    const msgDiv = document.createElement('div');
                    msgDiv.style.marginBottom = '10px';
                    msgDiv.style.padding = '8px';
                    msgDiv.style.background = msg.sender === 'user' ? 'rgba(59, 130, 246, 0.1)' : 'var(--primary-dark)';
                    msgDiv.style.borderRadius = '8px';
                    msgDiv.innerHTML = `<strong>${msg.sender === 'user' ? 'You' : 'AI'}:</strong> ${msg.content.substring(0, 100)}${msg.content.length > 100 ? '...' : ''}`;
                    chatMessagesPreview.appendChild(msgDiv);
                });
            } else {
                chatMessagesPreview.innerHTML = '<div style="color: var(--text-gray);">No messages in this chat</div>';
            }
        }

        function toggleChatSelection(chatId) {
            const checkbox = document.getElementById(`chat_${chatId}`);
            if (!checkbox) return;
            
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                if (!selectedChatsForProject.includes(chatId)) {
                    selectedChatsForProject.push(chatId);
                }
            } else {
                selectedChatsForProject = selectedChatsForProject.filter(id => id !== chatId);
            }
            
            updateSelectedChatsList();
        }

        function updateSelectedChatsList() {
            const selectedList = document.getElementById('selectedChatsList');
            const selectedCount = document.getElementById('selectedCount');
            
            selectedList.innerHTML = '';
            selectedCount.textContent = selectedChatsForProject.length;
            
            selectedChatsForProject.forEach(chatId => {
                const chat = chats.find(c => c.id === chatId);
                if (chat) {
                    const tag = document.createElement('div');
                    tag.className = 'selected-tag';
                    tag.innerHTML = `${chat.name} <span class="remove-tag" onclick="removeSelectedChat('${chatId}')"></span>`;
                    selectedList.appendChild(tag);
                }
            });
        }

        function removeSelectedChat(chatId) {
            selectedChatsForProject = selectedChatsForProject.filter(id => id !== chatId);
            const checkbox = document.getElementById(`chat_${chatId}`);
            if (checkbox) checkbox.checked = false;
            updateSelectedChatsList();
        }

        function filterProjectChats() {
            const searchTerm = document.getElementById('searchProjectChats').value.toLowerCase();
            const chatItems = document.querySelectorAll('.chat-select-item');
            
            chatItems.forEach(item => {
                const chatName = item.querySelector('.chat-select-info div:first-child').textContent.toLowerCase();
                item.style.display = chatName.includes(searchTerm) ? 'flex' : 'none';
            });
        }

        function saveChatAsFile() {
            const chatId = document.getElementById('chatSelect').value;
            const messageDiv = document.getElementById('addFileMessage');
            
            if (!chatId) {
                showMessage(messageDiv, 'Please select a chat to save', 'error');
                return;
            }
            
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;
            
            let chatText = `Chat: ${chat.name}\n`;
            chatText += `Created: ${new Date(chat.createdAt).toLocaleString()}\n`;
            chatText += `Saved: ${new Date().toLocaleString()}\n\n`;
            
            if (chat.messages && chat.messages.length > 0) {
                chat.messages.forEach(msg => {
                    const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const sender = msg.sender === 'user' ? 'You' : 'AI Assistant';
                    chatText += `[${time}] ${sender}: ${msg.content}\n\n`;
                });
            } else {
                chatText += 'No messages in this chat.\n';
            }
            
            const fileData = {
                id: 'chatfile_' + Date.now(),
                name: `Chat - ${chat.name}.txt`,
                type: 'text',
                size: new Blob([chatText]).size,
                content: chatText,
                addedAt: new Date().toISOString(),
                addedBy: currentUser.username,
                originalChatId: chatId
            };
            
            if (!currentProjectFiles.files) {
                currentProjectFiles.files = [];
            }
            
            currentProjectFiles.files.push(fileData);
            saveProjects();
            
            showMessage(messageDiv, `Chat "${chat.name}" saved as file!`, 'success');
            
            setTimeout(() => {
                closeAddFileModal();
                loadProjectFiles();
            }, 1000);
        }

        function importChatsToProject() {
            selectedChatsForProject = [];
            importChatsModal.classList.add('active');
            loadAvailableChats();
        }

        function closeImportChatsModal() {
            importChatsModal.classList.remove('active');
            selectedChatsForProject = [];
        }

        function addSelectedChatsToProject() {
            if (selectedChatsForProject.length === 0) {
                showMessage(document.getElementById('importChatsMessage'), 'Please select at least one chat', 'error');
                return;
            }
            
            if (!currentProjectFiles.chats) {
                currentProjectFiles.chats = [];
            }
            
            let addedCount = 0;
            selectedChatsForProject.forEach(chatId => {
                if (!currentProjectFiles.chats.includes(chatId)) {
                    currentProjectFiles.chats.push(chatId);
                    addedCount++;
                }
            });
            
            saveProjects();
            
            showMessage(document.getElementById('importChatsMessage'), `Added ${addedCount} chat(s) to project!`, 'success');
            
            setTimeout(() => {
                closeImportChatsModal();
                loadProjectFiles();
                switchFileTab('chats');
            }, 1000);
        }

        // File operations
        function viewFile(fileId) {
            const file = currentProjectFiles.files.find(f => f.id === fileId);
            if (!file) return;
            
            if (file.type === 'text' || file.type === 'document') {
                alert(`File Content:\n\n${file.content}`);
            } else {
                alert(`Preview not available for ${file.type} files. Download to view.`);
            }
        }

        function downloadFile(fileId) {
            const file = currentProjectFiles.files.find(f => f.id === fileId);
            if (!file) return;
            
            let content, mimeType, fileName;
            
            if (file.type === 'text' || file.type === 'document') {
                content = file.content;
                mimeType = 'text/plain';
                fileName = file.name.endsWith('.txt') ? file.name : file.name + '.txt';
            } else {
                content = file.content;
                mimeType = getMimeType(file.type);
                fileName = file.name;
            }
            
            const blob = file.type === 'text' || file.type === 'document' 
                ? new Blob([content], { type: mimeType })
                : dataURLtoBlob(content);
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function deleteFile(fileId) {
            if (!confirm('Are you sure you want to delete this file?')) return;
            
            currentProjectFiles.files = currentProjectFiles.files.filter(f => f.id !== fileId);
            saveProjects();
            loadProjectFiles();
        }

        function removeChatFromProject(chatId) {
            if (!confirm('Remove this chat from the project?')) return;
            
            currentProjectFiles.chats = currentProjectFiles.chats.filter(id => id !== chatId);
            saveProjects();
            loadProjectFiles();
        }

        function renameProjectFromFiles() {
            renameProject(currentProjectFiles.id);
            projectFilesModal.classList.remove('active');
        }

        function deleteProjectFromFiles() {
            deleteProject(currentProjectFiles.id);
            closeProjectFilesModal();
        }

        function exportProject() {
            const projectData = {
                project: currentProjectFiles,
                exportDate: new Date().toISOString(),
                exportedBy: currentUser.username
            };
            
            const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `UrbanSoft AI Project - ${currentProjectFiles.name} - ${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Helper functions for file management
        function getFileIcon(fileType) {
            const icons = {
                'text': '',
                'document': '',
                'image': '',
                'pdf': '',
                'audio': '',
                'video': '',
                'archive': '',
                'code': '',
                'spreadsheet': '',
                'presentation': ''
            };
            return icons[fileType] || '';
        }

        function getFileType(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            const types = {
                'txt': 'text',
                'md': 'text',
                'pdf': 'pdf',
                'jpg': 'image',
                'jpeg': 'image',
                'png': 'image',
                'gif': 'image',
                'mp3': 'audio',
                'wav': 'audio',
                'mp4': 'video',
                'avi': 'video',
                'zip': 'archive',
                'rar': 'archive',
                'js': 'code',
                'html': 'code',
                'css': 'code',
                'json': 'code',
                'xlsx': 'spreadsheet',
                'csv': 'spreadsheet',
                'ppt': 'presentation',
                'pptx': 'presentation'
            };
            return types[ext] || 'document';
        }

        function getMimeType(fileType) {
            const mimeTypes = {
                'text': 'text/plain',
                'document': 'text/plain',
                'image': 'image/*',
                'pdf': 'application/pdf',
                'audio': 'audio/*',
                'video': 'video/*',
                'archive': 'application/zip'
            };
            return mimeTypes[fileType] || 'application/octet-stream';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function dataURLtoBlob(dataURL) {
            const arr = dataURL.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], { type: mime });
        }

        function resetFileUploader() {
            document.querySelectorAll('.upload-methods').forEach(el => el.style.display = 'grid');
            document.getElementById('fileUploaderSection').style.display = 'none';
            document.getElementById('documentCreatorSection').style.display = 'none';
            document.getElementById('chatImporterSection').style.display = 'none';
            document.getElementById('uploadFilesBtn').style.display = 'none';
            document.getElementById('createDocumentBtn').style.display = 'none';
            document.getElementById('importChatBtn').style.display = 'none';
            document.getElementById('addFileMessage').innerHTML = '';
        }

        // CHAT MANAGEMENT FUNCTIONS
        function loadChats() {
            const savedChats = localStorage.getItem('urbansoft_chats_' + (currentUser?.username || 'guest'));
            if (savedChats) {
                chats = JSON.parse(savedChats);
            } else {
                chats = [];
            }
            renderChats();
        }

        function saveChats() {
            if (currentUser) {
                localStorage.setItem('urbansoft_chats_' + currentUser.username, JSON.stringify(chats));
            }
        }

        function renderChats() {
            const chatsList = document.getElementById('chatsList');
            const searchTerm = document.getElementById('searchChats').value.toLowerCase();
            
            chatsList.innerHTML = '';
            
            let filteredChats = chats;
            if (searchTerm) {
                filteredChats = chats.filter(chat => 
                    chat.name.toLowerCase().includes(searchTerm) ||
                    (chat.messages && chat.messages.some(msg => 
                        msg.content.toLowerCase().includes(searchTerm)
                    ))
                );
            }
            
            if (filteredChats.length === 0) {
                chatsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-gray);">
                        <div style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;"></div>
                        <p>${searchTerm ? 'No chats found' : 'No chats yet'}</p>
                        ${!searchTerm ? '<p style="font-size: 0.9rem; margin-top: 10px;">Start a new chat by clicking the + button</p>' : ''}
                    </div>`;
                return;
            }
            
            filteredChats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item' + (currentChat && currentChat.id === chat.id ? ' active' : '');
                chatItem.dataset.chatId = chat.id;
                chatItem.draggable = true;
                chatItem.classList.add('draggable');
                
                // Add drag events
                chatItem.addEventListener('dragstart', (e) => {
                    draggedChat = chat;
                    chatItem.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', chat.id);
                });
                
                chatItem.addEventListener('dragend', () => {
                    chatItem.classList.remove('dragging');
                    draggedChat = null;
                });
                
                let lastMessage = 'No messages yet';
                let lastTime = new Date(chat.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                if (chat.messages && chat.messages.length > 0) {
                    const lastMsg = chat.messages[chat.messages.length - 1];
                    lastMessage = lastMsg.content.length > 50 ? lastMsg.content.substring(0, 50) + '...' : lastMsg.content;
                    lastTime = new Date(lastMsg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
                
                chatItem.innerHTML = `
                    <div class="chat-info">
                        <div class="chat-name">${chat.name} <span style="font-size: 0.7rem; color: var(--accent-blue);">(drag to projects)</span></div>
                        <div class="chat-time">${lastTime}</div>
                    </div>
                    <div class="chat-preview">${lastMessage}</div>
                    <div class="chat-actions">
                        <button class="chat-action-btn" onclick="event.stopPropagation(); renameChat('${chat.id}')" title="Rename"></button>
                        <button class="chat-action-btn" onclick="event.stopPropagation(); deleteChat('${chat.id}')" title="Delete"></button>
                    </div>
                `;
                
                chatItem.addEventListener('click', (e) => {
                    if (!e.target.closest('.chat-actions') && !e.target.closest('.chat-name span')) {
                        openChat(chat);
                    }
                });
                
                chatsList.appendChild(chatItem);
            });
        }

        function createNewChat() {
            const newChat = {
                id: 'chat_' + Date.now(),
                name: 'New Chat ' + (chats.length + 1),
                createdAt: new Date().toISOString(),
                messages: [],
                createdBy: currentUser.username
            };
            
            chats.push(newChat);
            saveChats();
            openChat(newChat);
            renderChats();
            
            recordUserActivity(currentUser.id, 'Created Chat', `Created new chat: ${newChat.name}`);
        }

        function openChat(chat) {
            currentChat = chat;
            document.getElementById('currentChatTitle').textContent = chat.name;
            
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.chatId === chat.id) {
                    item.classList.add('active');
                }
            });
            
            loadChatMessages();
            
            recordUserActivity(currentUser.id, 'Opened Chat', `Opened chat: ${chat.name}`);
        }

        function loadChatMessages() {
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = '';
            
            if (!currentChat || !currentChat.messages || currentChat.messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="welcome-message">
                        <h3> Welcome to UrbanSoft AI</h3>
                        <p>Your professional assistant powered by OpenAI's GPT-4</p>
                        <p>How can I help you today?</p>
                    </div>`;
                return;
            }
            
            currentChat.messages.forEach(message => {
                addMessageToUI(message);
            });
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addMessageToUI(message) {
            const messagesContainer = document.getElementById('messagesContainer');
            
            const welcomeMsg = messagesContainer.querySelector('.welcome-message');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }
            
            const messageElement = document.createElement('div');
            messageElement.className = `message-bubble ${message.sender}`;
            
            const time = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageElement.innerHTML = `
                <div class="message-content">${message.content}</div>
                <div class="message-time">${time}</div>`;
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function renameChat(chatId) {
            const chat = chats.find(c => c.id === chatId);
            if (chat) {
                editingItem = chatId;
                editingType = 'chat';
                renameModal.classList.add('active');
                document.getElementById('renameInput').value = chat.name;
                document.getElementById('renameInput').focus();
            }
        }

        function deleteChat(chatId) {
            if (!confirm('Are you sure you want to delete this chat? This action cannot be undone.')) {
                return;
            }
            
            chats = chats.filter(c => c.id !== chatId);
            saveChats();
            
            if (currentChat && currentChat.id === chatId) {
                currentChat = null;
                document.getElementById('currentChatTitle').textContent = 'Welcome to UrbanSoft AI';
                loadChatMessages();
            }
            
            renderChats();
            
            recordUserActivity(currentUser.id, 'Deleted Chat', `Deleted chat: ${chatId}`);
        }

        function addChatToProject(projectId, chatId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            if (!project.chats) {
                project.chats = [];
            }
            
            if (!project.chats.includes(chatId)) {
                project.chats.push(chatId);
                saveProjects();
                
                showSuccessMessage(`Chat added to "${project.name}" project!`);
                
                if (currentProjectFiles && currentProjectFiles.id === projectId) {
                    loadProjectFiles();
                }
                
                recordUserActivity(currentUser.id, 'Added Chat to Project', `Added chat to project: ${project.name}`);
            }
        }

        function closeRenameModal() {
            renameModal.classList.remove('active');
            editingItem = null;
            editingType = null;
        }

        function saveRename() {
            const newName = document.getElementById('renameInput').value.trim();
            
            if (!newName) {
                alert('Please enter a name');
                return;
            }
            
            if (editingType === 'chat') {
                const chat = chats.find(c => c.id === editingItem);
                if (chat) {
                    chat.name = newName;
                    saveChats();
                    
                    if (currentChat && currentChat.id === editingItem) {
                        currentChat.name = newName;
                        document.getElementById('currentChatTitle').textContent = newName;
                    }
                    
                    renderChats();
                    recordUserActivity(currentUser.id, 'Renamed Chat', `Renamed chat to: ${newName}`);
                }
            } else if (editingType === 'project') {
                const project = projects.find(p => p.id === editingItem);
                if (project) {
                    project.name = newName;
                    saveProjects();
                    renderProjects();
                    recordUserActivity(currentUser.id, 'Renamed Project', `Renamed project to: ${newName}`);
                }
            }
            
            closeRenameModal();
        }

        // Drag and Drop initialization
        function initializeDragAndDrop() {
            const projectsContainer = document.getElementById('projectsList');
            const chatsContainer = document.getElementById('chatsList');
            
            projectsContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
            
            projectsContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                const chatId = e.dataTransfer.getData('text/plain');
                if (chatId && draggedChat) {
                    const elements = document.elementsFromPoint(e.clientX, e.clientY);
                    const projectItem = elements.find(el => el.classList.contains('project-item'));
                    if (projectItem) {
                        const projectId = projectItem.dataset.projectId;
                        addChatToProject(projectId, chatId);
                    }
                }
            });
        }

        // Enhanced sendMessage with hidden commands
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }

        function handleEnterKey(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || isGeneratingResponse) {
                return;
            }
            
            // Check for hidden commands first
            if (checkForHiddenCommands(message)) {
                messageInput.value = '';
                autoResizeTextarea(messageInput);
                return; // Don't send to AI if it's a command
            }
            
            messageInput.value = '';
            autoResizeTextarea(messageInput);
            
            if (!currentChat) {
                createNewChat();
            }
            
            const userMessage = {
                sender: 'user',
                content: message,
                timestamp: new Date().toISOString()
            };
            
            if (!currentChat.messages) {
                currentChat.messages = [];
            }
            
            currentChat.messages.push(userMessage);
            saveChats();
            addMessageToUI(userMessage);
            
            const messagesContainer = document.getElementById('messagesContainer');
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            messagesContainer.appendChild(typingIndicator);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            isGeneratingResponse = true;
            document.getElementById('sendBtn').disabled = true;
            
            try {
                const response = await callOpenAIAPI(message, currentChat.messages.slice(0, -1));
                
                typingIndicator.remove();
                
                const aiMessage = {
                    sender: 'ai',
                    content: response,
                    timestamp: new Date().toISOString()
                };
                
                currentChat.messages.push(aiMessage);
                saveChats();
                addMessageToUI(aiMessage);
                
                const chatItem = document.querySelector(`.chat-item[data-chat-id="${currentChat.id}"]`);
                if (chatItem) {
                    const preview = chatItem.querySelector('.chat-preview');
                    if (preview) {
                        preview.textContent = response.length > 50 ? response.substring(0, 50) + '...' : response;
                    }
                }
                
                recordUserActivity(currentUser.id, 'Sent Message', `Sent message in chat: ${currentChat.name}`);
                
            } catch (error) {
                console.error('Error generating response:', error);
                
                typingIndicator.remove();
                
                const errorMessage = {
                    sender: 'ai',
                    content: 'Sorry, I encountered an error generating a response. Please try again.',
                    timestamp: new Date().toISOString()
                };
                
                currentChat.messages.push(errorMessage);
                saveChats();
                addMessageToUI(errorMessage);
            } finally {
                isGeneratingResponse = false;
                document.getElementById('sendBtn').disabled = false;
                messageInput.focus();
            }
        }

        async function callOpenAIAPI(message, history) {
            apiUsageCount++;
            saveApiConfiguration();
            
            try {
                // Format conversation history for OpenAI
                const messages = [];
                
                // Add system message
                messages.push({
                    role: "system",
                    content: "You are UrbanSoft AI, a professional assistant powered by OpenAI's GPT-4. Provide helpful, accurate, and professional responses."
                });
                
                // Add conversation history
                history.forEach(msg => {
                    messages.push({
                        role: msg.sender === 'user' ? 'user' : 'assistant',
                        content: msg.content
                    });
                });
                
                // Add current message
                messages.push({
                    role: "user",
                    content: message
                });
                
                const model = currentUser?.settings?.aiModel || 'gpt-3.5-turbo';
                const temperature = currentUser?.settings?.temperature || 0.7;
                
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: messages,
                        temperature: temperature,
                        max_tokens: 1024,
                        top_p: 0.95,
                        frequency_penalty: 0,
                        presence_penalty: 0
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`OpenAI API request failed: ${errorData.error?.message || response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    return data.choices[0].message.content;
                } else {
                    throw new Error('Invalid response format from OpenAI API');
                }
            } catch (error) {
                console.error('OpenAI API Error:', error);
                
                // If the API key is invalid or there's an authentication error
                if (error.message.includes('401') || error.message.includes('authentication')) {
                    return ' API Error: Please check your OpenAI API key configuration. The current key appears to be invalid or expired.';
                }
                
                // If there's a rate limit error
                if (error.message.includes('429') || error.message.includes('rate limit')) {
                    return ' API Error: Rate limit exceeded. Please wait a moment before trying again.';
                }
                
                throw error;
            }
        }

        function attachFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = true;
            input.accept = '.txt,.pdf,.doc,.docx,.jpg,.jpeg,.png,.gif';
            
            input.onchange = (e) => {
                const files = e.target.files;
                if (files.length > 0) {
                    const messageInput = document.getElementById('messageInput');
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        if (i > 0) messageInput.value += '\n';
                        messageInput.value += `[Attached: ${file.name}] `;
                    }
                    autoResizeTextarea(messageInput);
                }
            };
            
            input.click();
        }

        function closeDropdownOnClickOutside(event) {
            const dropdown = document.getElementById('dropdownMenu');
            const menuBtn = document.querySelector('.chat-menu-btn');
            
            if (!dropdown.contains(event.target) && !menuBtn.contains(event.target)) {
                dropdown.classList.remove('show');
                document.removeEventListener('click', closeDropdownOnClickOutside);
            }
        }

        function openSettings() {
            loadSettingsUI();
            settingsModal.classList.add('active');
        }

        function closeSettings() {
            settingsModal.classList.remove('active');
        }

        function loadSettingsUI() {
            if (!currentUser) return;
            
            // Profile
            document.getElementById('profileFullName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
            document.getElementById('profileUsername').textContent = `@${currentUser.username}`;
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profileAvatar').textContent = `${currentUser.firstName.charAt(0)}${currentUser.lastName.charAt(0)}`;
            
            document.getElementById('profileFirstName').value = currentUser.firstName;
            document.getElementById('profileLastName').value = currentUser.lastName;
            document.getElementById('profileEmailInput').value = currentUser.email;
            document.getElementById('profileUsernameInput').value = currentUser.username;
            
            // General
            document.getElementById('themeSelect').value = currentUser.settings.theme || 'dark';
            document.getElementById('autoLogin').checked = currentUser.settings.autoLogin || false;
            document.getElementById('saveHistory').checked = currentUser.settings.saveHistory !== false;
            
            // AI Preferences
            document.getElementById('aiModelSelect').value = currentUser.settings.aiModel || 'gpt-4';
            document.getElementById('aiStyleSelect').value = currentUser.settings.aiStyle || 'professional';
            document.getElementById('aiLengthSelect').value = currentUser.settings.responseLength || 'medium';
            document.getElementById('temperatureSlider').value = currentUser.settings.temperature || 0.7;
            document.getElementById('temperatureValue').textContent = currentUser.settings.temperature || 0.7;
            
            // Security
            document.getElementById('tfaToggle').checked = currentUser.tfaEnabled || false;
            document.getElementById('tfaStatusText').textContent = currentUser.tfaEnabled ? 'Enabled' : 'Disabled';
            document.getElementById('tfaActionBtn').textContent = currentUser.tfaEnabled ? 'Disable 2FA' : 'Enable 2FA';
            document.getElementById('autoLogoutSelect').value = currentUser.settings.autoLogout || '60';
            document.getElementById('sessionWarning').checked = currentUser.settings.sessionWarning !== false;
            
            // PIN Management visibility
            const pinManagement = document.getElementById('pinManagement');
            if (currentUser.tfaEnabled) {
                pinManagement.style.display = 'block';
            } else {
                pinManagement.style.display = 'none';
            }
            
            // Highlight current theme card
            const themeCards = document.querySelectorAll('.theme-card');
            themeCards.forEach(card => card.classList.remove('active'));
            const currentTheme = currentUser.settings.theme || 'dark';
            document.getElementById(currentTheme + 'ThemeCard').classList.add('active');
        }

        function switchSettingsTab(tabName) {
            document.querySelectorAll('.settings-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.settings-section').forEach(section => section.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function saveProfile(event) {
            event.preventDefault();
            
            const firstName = document.getElementById('profileFirstName').value.trim();
            const lastName = document.getElementById('profileLastName').value.trim();
            const email = document.getElementById('profileEmailInput').value.trim();
            const username = document.getElementById('profileUsernameInput').value.trim();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            const messageDiv = document.getElementById('profileMessage');
            
            if (currentUser.password !== currentPassword) {
                showMessage(messageDiv, 'Current password is incorrect', 'error');
                return;
            }
            
            if (username !== currentUser.username) {
                const adminData = localStorage.getItem('urbansoft_admin');
                if (adminData) {
                    const admin = JSON.parse(adminData);
                    if (username === admin.username && currentUser.id !== admin.id) {
                        showMessage(messageDiv, 'Username already exists', 'error');
                        return;
                    }
                }
                
                const users = JSON.parse(localStorage.getItem('urbansoft_users') || '[]');
                if (users.some(u => u.username === username && u.id !== currentUser.id)) {
                    showMessage(messageDiv, 'Username already exists', 'error');
                    return;
                }
            }
            
            if (email !== currentUser.email) {
                const users = JSON.parse(localStorage.getItem('urbansoft_users') || '[]');
                if (users.some(u => u.email === email && u.id !== currentUser.id)) {
                    showMessage(messageDiv, 'Email already exists', 'error');
                    return;
                }
            }
            
            if (newPassword) {
                if (newPassword.length < 8 && currentUser.role !== 'admin') {
                    showMessage(messageDiv, 'Password must be at least 8 characters', 'error');
                    return;
                }
                
                if (newPassword !== confirmNewPassword) {
                    showMessage(messageDiv, 'New passwords do not match', 'error');
                    return;
                }
                
                currentUser.password = newPassword;
            }
            
            currentUser.firstName = firstName;
            currentUser.lastName = lastName;
            currentUser.email = email;
            currentUser.username = username;
            
            saveUserData();
            
            document.getElementById('currentUsername').textContent = currentUser.username;
            document.getElementById('profileFullName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
            document.getElementById('profileUsername').textContent = `@${currentUser.username}`;
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profileAvatar').textContent = `${currentUser.firstName.charAt(0)}${currentUser.lastName.charAt(0)}`;
            
            recordUserActivity(currentUser.id, 'Updated Profile', 'Updated profile information');
            
            showMessage(messageDiv, 'Profile updated successfully!', 'success');
            
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
        }

        function toggle2FA() {
            if (currentUser.tfaEnabled) {
                if (confirm('Are you sure you want to disable Two-Factor Authentication?')) {
                    currentUser.tfaEnabled = false;
                    currentUser.tfaPIN = null;
                    saveUserData();
                    loadSettingsUI();
                    recordUserActivity(currentUser.id, 'Disabled 2FA', 'Disabled two-factor authentication');
                }
            } else {
                show2FASetup();
            }
        }

        function saveUserData() {
            if (currentUser.role === 'admin' && currentUser.id.startsWith('admin_')) {
                localStorage.setItem('urbansoft_admin', JSON.stringify(currentUser));
            } else {
                const users = JSON.parse(localStorage.getItem('urbansoft_users') || '[]');
                const userIndex = users.findIndex(u => u.id === currentUser.id);
                if (userIndex !== -1) {
                    users[userIndex] = currentUser;
                    localStorage.setItem('urbansoft_users', JSON.stringify(users));
                }
            }
            
            localStorage.setItem('urbansoft_user', JSON.stringify(currentUser));
        }

        function exportChat() {
            if (!currentChat || !currentChat.messages || currentChat.messages.length === 0) {
                alert('No chat messages to export');
                return;
            }
            
            let exportText = `UrbanSoft AI Chat Export\n`;
            exportText += `Chat: ${currentChat.name}\n`;
            exportText += `Created: ${new Date(currentChat.createdAt).toLocaleString()}\n`;
            exportText += `Exported: ${new Date().toLocaleString()}\n\n`;
            exportText += `Messages:\n\n`;
            
            currentChat.messages.forEach(msg => {
                const sender = msg.sender === 'user' ? 'You' : 'AI Assistant';
                const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                exportText += `[${time}] ${sender}: ${msg.content}\n\n`;
            });
            
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `UrbanSoft AI Chat - ${currentChat.name} - ${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            recordUserActivity(currentUser.id, 'Exported Chat', `Exported chat: ${currentChat.name}`);
        }

        function clearChat() {
            if (!currentChat || !currentChat.messages || currentChat.messages.length === 0) {
                return;
            }
            
            if (confirm('Are you sure you want to clear all messages in this chat? This cannot be undone.')) {
                currentChat.messages = [];
                saveChats();
                loadChatMessages();
                recordUserActivity(currentUser.id, 'Cleared Chat', `Cleared chat: ${currentChat.name}`);
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Check if we're in an impersonation session
                const originalUserData = localStorage.getItem('urbansoft_original_user');
                if (originalUserData) {
                    if (confirm('You are currently impersonating another user. Do you want to return to your original account instead?')) {
                        returnFromImpersonation();
                        return;
                    }
                }
                
                currentUser = null;
                currentChat = null;
                currentProjectFiles = null;
                chats = [];
                projects = [];
                
                localStorage.removeItem('urbansoft_user');
                localStorage.removeItem('urbansoft_original_user');
                
                authScreen.style.display = 'flex';
                chatApp.style.display = 'none';
                
                document.getElementById('signinUsername').value = '';
                document.getElementById('signinPassword').value = '';
                document.getElementById('signinMessage').textContent = '';
                
                document.getElementById('firstName').value = '';
                document.getElementById('lastName').value = '';
                document.getElementById('email').value = '';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('confirmPassword').value = '';
                document.getElementById('signupMessage').textContent = '';
                
                switchTab('signin');
            }
        }

        function clearAllData() {
            if (confirm(' WARNING: This will delete ALL your data including chats, projects, and settings. This action cannot be undone. Are you sure?')) {
                localStorage.clear();
                alert('All data has been cleaned. The page will now reload.');
                location.reload();
            }
        }

        function exportAllData() {
            const adminData = localStorage.getItem('urbansoft_admin');
            const users = JSON.parse(localStorage.getItem('urbansoft_users') || '[]');
            const allUsers = adminData ? [JSON.parse(adminData), ...users] : users;
            
            const allData = {
                users: allUsers,
                chats: chats,
                projects: projects,
                activities: userActivities,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `UrbanSoft AI Backup - ${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            recordUserActivity(currentUser.id, 'Exported All Data', 'Exported all user data');
        }

        function checkForUpdates() {
            alert('You are using the latest version of UrbanSoft AI (v2.0.0).');
        }

        // Initialize search functionality
        document.getElementById('searchChats').addEventListener('input', renderChats);

        // Initialize the app
        window.onload = initializeApp;

        // Make confirmAction function globally available
        window.confirmAction = confirmAction;
        
        // Make showHiddenCommands available
        window.showHiddenCommands = showHiddenCommands;
    </script>
</body>
</html>